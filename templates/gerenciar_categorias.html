{% load static %}
{% load user_tags %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if brand.enabled %}{{ brand.name_short }}{% else %}{{ brand.name_old }}{% endif %} - Gerenciar Categorias</title>

    <!-- Favicons -->
    {% include 'partials/favicon_meta.html' %}

  <!-- CSS personalizado -->
  <link rel="stylesheet" type="text/css" href="{% static 'css/global.css' %}" />
  <link rel="stylesheet" type="text/css" href="{% static 'css/gerenciar.css' %}" />
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“‚ Gerenciamento de Categorias</h1>
      <p>Crie e organize as categorias de perguntas para avaliaÃ§Ãµes</p>
    </div>

    <!-- NavegaÃ§Ã£o Breadcrumb -->
    <div class="nav-breadcrumb">
      <a href="{% url 'inicio' %}">ğŸ  InÃ­cio</a>
      <span>â†’</span>
      <a href="{% url 'listar_avaliacoes' %}">âš™ï¸ Lista de AvaliaÃ§Ãµes</a>
      <span>â†’</span>
      <span>ğŸ“‚ Categorias</span>
    </div>

    {% include "partials/messages.html" %}

    <div class="form-section">
      <h2>
        {% if editing %}âœï¸ Editar Categoria{% else %}ğŸ“ Criar Nova Categoria{% endif %}
      </h2>
      <form method="post">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.nome.id_for_label }}">{{ form.nome.label }}</label>
            {{ form.nome }}
            {% if form.nome.errors %}
            <div class="error-message">
              {% for error in form.nome.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="form-group small">
            <label for="{{ form.ordem.id_for_label }}">{{ form.ordem.label }}</label>
            {{ form.ordem }}
            {% if form.ordem.errors %}
            <div class="error-message">
              {% for error in form.ordem.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-group">
          <label for="{{ form.descricao.id_for_label }}">{{ form.descricao.label }}</label>
          {{ form.descricao }}
          {% if form.descricao.errors %}
          <div class="error-message">
            {% for error in form.descricao.errors %}{{ error }}{% endfor %}
          </div>
          {% endif %}
        </div>

        {% if form.non_field_errors %}
        <div class="error-message">
          {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}

        <button type="submit" class="btn">
          {% if editing %}ğŸ’¾ Atualizar Categoria{% else %}â• Criar Categoria{% endif %}
        </button>
        {% if editing %}
        <a href="{% url 'gerenciar_categorias' %}" class="btn btn-secondary">Cancelar</a>
        {% endif %}
      </form>
    </div>

    <!-- SeÃ§Ã£o de InformaÃ§Ãµes sobre Categorias -->
    <div class="form-section">
      <h2>â„¹ï¸ InformaÃ§Ãµes sobre Categorias</h2>
      
      <div class="info-content">
        <p><strong>ğŸ“‹ O que sÃ£o categorias?</strong></p>
        <p>As categorias organizam as perguntas da avaliaÃ§Ã£o em grupos temÃ¡ticos, facilitando a compreensÃ£o e anÃ¡lise dos resultados.</p>
        
        <p><strong>ğŸ”¢ Como funciona o campo "Ordem"?</strong></p>
        <p>O campo ordem define a sequÃªncia em que as categorias aparecerÃ£o na avaliaÃ§Ã£o. Use nÃºmeros Ãºnicos crescentes para organizar logicamente:</p>
        
        <div class="example-box">
          <h4>ğŸ“ Exemplo de organizaÃ§Ã£o pedagÃ³gica:</h4>
          <ul>
            <li><strong>1. DidÃ¡tica (ordem: 1)</strong>
              <ul>
                <li>O professor explica claramente?</li>
                <li>O conteÃºdo Ã© bem organizado?</li>
              </ul>
            </li>
            <li><strong>2. Relacionamento (ordem: 2)</strong>
              <ul>
                <li>O professor Ã© acessÃ­vel?</li>
                <li>Demonstra interesse pelo aprendizado?</li>
              </ul>
            </li>
            <li><strong>3. AvaliaÃ§Ã£o (ordem: 3)</strong>
              <ul>
                <li>Os critÃ©rios sÃ£o claros?</li>
                <li>O feedback Ã© Ãºtil?</li>
              </ul>
            </li>
          </ul>
        </div>
        
        <div class="info-alert">
          <strong class="alert-title">ğŸ’¡ Dicas importantes:</strong>
          <div class="alert-text">
            <ul>
              <li><strong>Ordem Ãºnica:</strong> Cada categoria deve ter uma ordem diferente (nÃ£o pode repetir)</li>
              <li><strong>ComeÃ§a em 1:</strong> Use nÃºmeros a partir de 1 (nÃ£o aceita 0)</li>
              <li><strong>SugestÃ£o:</strong> Use intervalos de 10 (10, 20, 30...) para facilitar inserÃ§Ãµes futuras</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

<!-- Filtros e Busca -->
      <div class="filters-section">
        <h3 class="filters-title">ğŸ” Filtros</h3>
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchCategoriaNome">Buscar por Nome:</label>
            <div class="search-box">
              <input type="text" 
                     id="searchCategoriaNome" 
                     class="form-control"
                     placeholder="Digite o nome da categoria..."
                     autocomplete="off">
            </div>
          </div>
          
          <div class="filter-group">
            <button type="button" class="btn-filter" onclick="clearFilters()">Limpar Filtros</button>
          </div>
        </div>
      </div>


    <!-- SeÃ§Ã£o de Categorias (sempre visÃ­vel) -->
    <div class="form-section">
      <div class="section-header">
        <h2>ğŸ“‹ Categorias Cadastradas ({{ categorias|length }})</h2>
      </div>

      {% if categorias %}
              <div class="table-scroll-hint">
          <small>ğŸ’¡ Dica: Arraste a tabela lateralmente para ver mais colunas</small>
      </div>
        <div class="table-responsive">
        <table class="data-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>DescriÃ§Ã£o</th>
              <th>Ordem</th>
              <th>Perguntas</th>
              <th>AÃ§Ãµes</th>
            </tr>
          </thead>
          <tbody>
            {% for categoria in categorias %}
            <tr>
              <td><strong>{{ categoria.nome }}</strong></td>
              <td>
                {% if categoria.descricao %}
                  {{ categoria.descricao|truncatechars:50 }}
                {% else %}
                  <em class="text-muted">Sem descriÃ§Ã£o</em>
                {% endif %}
              </td>
              <td>
                <span class="counter-badge">{{ categoria.ordem }}</span>
              </td>
              <td>
                <span class="counter-badge">{{ categoria.perguntas.count }}</span>
                <small class="text-muted">pergunta{{ categoria.perguntas.count|pluralize }}</small>
              </td>
              <td>
                <div class="btn-group">
                  <a href="{% url 'editar_categoria_simples' categoria.id %}" 
                     class="btn btn-sm btn-secondary" 
                     title="Editar categoria">
                    âœï¸ Editar
                  </a>
                  {% if categoria.perguntas.count == 0 %}
                    <form method="post" action="{% url 'excluir_categoria' categoria.id %}" 
                          class="inline-form"
                          onsubmit="return confirm('Tem certeza que deseja excluir a categoria \'{{ categoria.nome|escapejs }}\'?\n\nEsta aÃ§Ã£o nÃ£o poderÃ¡ ser desfeita.')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" 
                              title="Excluir categoria">
                        ğŸ—‘ï¸ Excluir
                      </button>
                    </form>
                  {% else %}
                    <button type="button" class="btn btn-sm btn-danger disabled-state" 
                            title="NÃ£o Ã© possÃ­vel excluir esta categoria pois ela possui {{ categoria.perguntas.count }} pergunta(s) associada(s)"
                            onclick="alert('NÃ£o Ã© possÃ­vel excluir esta categoria pois ela possui {{ categoria.perguntas.count }} pergunta(s) associada(s).')">
                      ğŸ—‘ï¸ Excluir
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      {% else %}
        <div class="empty-state">
          <h3>ğŸ“‚ Nenhuma categoria cadastrada</h3>
          <p>Crie a primeira categoria para organizar as perguntas das avaliaÃ§Ãµes.</p>
        </div>
      {% endif %}
    </div>
  </div>

  <script src="{% static 'js/gerenciar-global.js' %}"></script>
  <script>
    // FunÃ§Ã£o para filtrar a tabela
    function filterTable() {
      const nomeFilter = document.getElementById('searchCategoriaNome').value.toLowerCase();
      
      const tableRows = document.querySelectorAll('.data-table tbody tr');
      let visibleCount = 0;

      tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        
        if (cells.length > 1) {
          const categoriaNome = cells[0].textContent.toLowerCase().trim();

          const nomeMatch = !nomeFilter || categoriaNome.includes(nomeFilter);

          if (nomeMatch) {
            row.style.display = '';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        }
      });

      // Atualiza o contador
      const sectionHeader = document.querySelector('.section-header h2');
      if (sectionHeader) {
        sectionHeader.textContent = `ğŸ“‹ Categorias Cadastradas (${visibleCount})`;
      }
    }

    // FunÃ§Ã£o para limpar filtros
    function clearFilters() {
      document.getElementById('searchCategoriaNome').value = '';
      filterTable();
    }

    // Adicionar event listeners para filtros
    document.addEventListener('DOMContentLoaded', function() {
      const searchCategoriaNome = document.getElementById('searchCategoriaNome');

      if (searchCategoriaNome) searchCategoriaNome.addEventListener('input', filterTable);
      
      console.log("PÃ¡gina de categorias carregada com filtros funcionais");
    });
  </script>
</body>
</html>
