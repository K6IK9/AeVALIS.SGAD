{% load user_tags %} {% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerenciar Ciclos de Avalia√ß√£o - IF SADD</title>

    <!-- CSS personalizado -->
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'css/global.css' %}"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{% static 'css/gerenciar.css' %}"
    />
  </head>

  <body>
    <main>
      <div class="container">
        <!-- Header da p√°gina -->
        <div class="header">
          <h1>Gerenciar Ciclos de Avalia√ß√£o</h1>
          <p>Crie e gerencie ciclos de avalia√ß√£o docente</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
          <a href="{% url 'inicio' %}">üè† In√≠cio</a>
          <span>‚Üí</span>
          <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
          <span>‚Üí</span>
          <span>üîÑ Ciclos de Avalia√ß√£o</span>
        </div>

        <!-- Mensagens -->
        {% if messages %}
        <div class="messages">
          {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Conte√∫do principal -->

        <!-- Formul√°rio Unificado -->
        <div class="form-section">
          <h2>
            {% if editing %} ‚úèÔ∏è Editar Ciclo de Avalia√ß√£o {% else %} ‚ûï Criar
            Novo Ciclo de Avalia√ß√£o {% endif %}
          </h2>
          <form method="post">
            {% csrf_token %}
            <div class="form-group">
              <label for="{{ form.nome.id_for_label }}">
                <strong>{{ form.nome.label }}</strong>
              </label>
              {{ form.nome }} {% if form.nome.errors %}
              <div class="form-error">
                {% for error in form.nome.errors %}
                <small>{{ error }}</small>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.periodo_letivo.id_for_label }}">
                <strong>{{ form.periodo_letivo.label }}</strong>
              </label>
              {{ form.periodo_letivo }} {% if form.periodo_letivo.errors %}
              <div class="form-error">
                {% for error in form.periodo_letivo.errors %}
                <small>{{ error }}</small>
                {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.questionario.id_for_label }}">
                <strong>{{ form.questionario.label }}</strong>
              </label>
              {{ form.questionario }} {% if form.questionario.errors %}
              <div class="form-error">
                {% for error in form.questionario.errors %}
                <small>{{ error }}</small>
                {% endfor %}
              </div>
              {% endif %}
              <small class="help-text">
                Selecione o question√°rio que ser√° utilizado neste ciclo de
                avalia√ß√£o
              </small>
            </div>

            <div class="form-grid form-grid-2">
              <div class="form-group">
                <label for="{{ form.data_inicio.id_for_label }}">
                  <strong>{{ form.data_inicio.label }}</strong>
                </label>
                {{ form.data_inicio }} {% if form.data_inicio.errors %}
                <div class="form-error">
                  {% for error in form.data_inicio.errors %}
                  <small>{{ error }}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.data_fim.id_for_label }}">
                  <strong>{{ form.data_fim.label }}</strong>
                </label>
                {{ form.data_fim }} {% if form.data_fim.errors %}
                <div class="form-error">
                  {% for error in form.data_fim.errors %}
                  <small>{{ error }}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="form-grid form-grid-single">
              <div class="form-group" class="form-group-limited">
                <div class="form-flex">
                  {{ form.enviar_lembrete_email }}
                  <label for="{{ form.enviar_lembrete_email.id_for_label }}">
                    {{ form.enviar_lembrete_email.label }}
                  </label>
                </div>
                {% if form.enviar_lembrete_email.errors %}
                <div class="form-error">
                  {% for error in form.enviar_lembrete_email.errors %}
                  <small>{{ error }}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <div class="form-group">
              <label for="{{ form.turmas.id_for_label }}">
                <strong>{{ form.turmas.label }}</strong>
              </label>
              <div class="turma-container">
                {% for choice in form.turmas %}
                <div class="turma-item">
                  <div class="turma-item-content">
                    <span class="turma-checkbox-wrapper">
                      {{ choice.tag }}
                    </span>
                    <label for="{{ choice.id_for_label }}" class="turma-label">
                      {{ choice.choice_label|truncatechars:60 }}
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% if form.turmas.errors %}
              <div class="form-error">
                {% for error in form.turmas.errors %}
                <small>{{ error }}</small>
                {% endfor %}
              </div>
              {% endif %}
              <small class="help-text"> {{ form.turmas.help_text }} </small>
            </div>

            {% if form.non_field_errors %}
            <div class="form-error">
              {% for error in form.non_field_errors %}
              <small>{{ error }}</small>
              {% endfor %}
            </div>
            {% endif %}

            <div class="form-actions">
              <a
                href="{% if editing %}{% url 'gerenciar_ciclos' %}{% else %}{% url 'listar_avaliacoes' %}{% endif %}"
                class="btn btn-secondary"
              >
                ‚Üê Cancelar
              </a>
              <button type="submit" class="btn">
                {% if editing %} ‚úì Salvar Altera√ß√µes {% else %} ‚úì Criar Ciclo {%
                endif %}
              </button>
            </div>
          </form>
        </div>
        {% if not editing %}
        <div class="form-section">
          <h2>üìã Ciclos de Avalia√ß√£o Cadastrados</h2>
          <div class="info-section">
            <strong>Total de ciclos:</strong> {{ ciclos.count }}
          </div>

          {% if ciclos %}
          <div class="data-table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th class="col-nome">Nome</th>
                  <th class="col-periodo">Per√≠odo Letivo</th>
                  <th class="col-questionario">Question√°rio</th>
                  <th class="col-data">In√≠cio</th>
                  <th class="col-data">Fim</th>
                  <th class="col-status">Status</th>
                  <th class="col-ativo">Ativo</th>
                  <th class="col-acoes">A√ß√µes</th>
                </tr>
              </thead>
              <tbody>
                {% for ciclo in ciclos %}
                <tr>
                  <td class="col-nome"><strong>{{ ciclo.nome }}</strong></td>
                  <td class="col-periodo">{{ ciclo.periodo_letivo.nome }}</td>
                  <td class="col-questionario">
                    {{ ciclo.questionario.titulo }}
                  </td>
                  <td class="col-data">
                    {{ ciclo.data_inicio|date:"d/m/Y H:i" }}
                  </td>
                  <td class="col-data">
                    {{ ciclo.data_fim|date:"d/m/Y H:i" }}
                  </td>
                  <td class="col-status">
                    {% if ciclo.status == 'agendado' %}
                    <span class="badge bg-warning">üìÖ Agendado</span>
                    {% elif ciclo.status == 'em_andamento' %}
                    <span class="badge bg-info">‚è≥ Em Andamento</span>
                    {% elif ciclo.status == 'finalizado' %}
                    <span class="badge bg-success">‚úÖ Finalizado</span>
                    {% endif %}
                  </td>
                  <td class="col-ativo">
                    {% if ciclo.ativo %}
                    <span class="badge bg-success">‚úÖ Ativo</span>
                    {% else %}
                    <span class="badge bg-secondary">‚ùå Inativo</span>
                    {% endif %}
                  </td>
                  <td class="col-acoes">
                    <div class="action-buttons">
                      <a
                        href="{% url 'detalhe_ciclo_avaliacao' ciclo.id %}"
                        class="btn btn-sm"
                        title="Visualizar"
                      >
                        üëÅÔ∏è Ver
                      </a>
                      <a
                        href="{% url 'editar_ciclo_simples' ciclo.id %}"
                        class="btn btn-sm btn-secondary"
                        title="Editar"
                      >
                        ‚úèÔ∏è Editar
                      </a>
                      <form
                        method="post"
                        action="{% url 'excluir_ciclo' ciclo.id %}"
                        class="inline-form form-excluir-ciclo"
                        data-ciclo="{{ ciclo.nome }}"
                      >
                        {% csrf_token %}
                        <input type="hidden" name="confirm_cascade" value="0" />
                        <button
                          type="submit"
                          class="btn btn-sm btn-danger"
                          title="Excluir"
                        >
                          üóëÔ∏è Excluir
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state">
            <p class="empty-message">Nenhum ciclo de avalia√ß√£o encontrado.</p>
            <p>Crie o primeiro ciclo para come√ßar a gerenciar avalia√ß√µes.</p>
          </div>
          {% endif %}
        </div>
        {% endif %}

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            document
              .querySelectorAll(".form-excluir-ciclo")
              .forEach(function (form) {
                form.addEventListener("submit", function (e) {
                  const hidden = form.querySelector(
                    'input[name="confirm_cascade"]'
                  );
                  if (hidden.value === "0") {
                    const nome = form.getAttribute("data-ciclo");
                    const msg = `Voc√™ est√° prestes a excluir o ciclo "${nome}".\n\nSe ele possuir avalia√ß√µes e respostas elas ser√£o EXCLU√çDAS EM CASCATA.\n\nConfirme para continuar.`;
                    if (!confirm(msg)) {
                      e.preventDefault();
                      return false;
                    }
                    // Primeira confirma√ß√£o: marca para cascata se necess√°rio.
                    hidden.value = "1";
                    // Permite envio; servidor validar√° se precisa da segunda etapa (warning pr√©vio j√° tratado por messages).
                  } else {
                    // Segunda submiss√£o j√° confirmada
                  }
                });
              });
          });
        </script>

        <div class="form-section info-sidebar">
          <h2 class="info-title">üìÖ Informa√ß√µes sobre Ciclos</h2>
          <div class="info-content">
            <h4 class="info-subtitle">O que √© um Ciclo de Avalia√ß√£o?</h4>
            <p class="info-paragraph">
              Um ciclo de avalia√ß√£o √© um per√≠odo determinado onde estudantes
              podem avaliar disciplinas e professores. Cada ciclo possui um
              question√°rio espec√≠fico, datas de in√≠cio e fim, e est√° associado a
              um per√≠odo letivo.
            </p>

            <div class="info-section-divider">
              <h5 class="info-subsection-title">Configura√ß√µes Importantes:</h5>
              <ul class="info-list">
                <li>
                  <strong>Per√≠odo Letivo:</strong> Define o semestre/ano da
                  avalia√ß√£o
                </li>
                <li>
                  <strong>Question√°rio:</strong> Conjunto de perguntas a serem
                  respondidas
                </li>
                <li>
                  <strong>Turmas:</strong> Definem quais disciplinas/professores
                  ser√£o avaliados
                </li>
                <li>
                  <strong>Datas:</strong> Per√≠odo em que as avalia√ß√µes ficam
                  dispon√≠veis
                </li>
                <li>
                  <strong>Status:</strong> Controla se o ciclo est√° ativo para
                  avalia√ß√µes
                </li>
              </ul>
            </div>

            <div class="info-alert">
              <strong class="alert-title">‚ö†Ô∏è Aten√ß√£o:</strong>
              <span class="alert-text">
                Ap√≥s criar um ciclo, certifique-se de ativ√°-lo para que os
                estudantes possam realizar as avalia√ß√µes no per√≠odo definido.
              </span>
            </div>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>
