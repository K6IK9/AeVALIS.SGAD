{% load user_tags %} {% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IF SADD - Gerenciar Disciplinas</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Gerenciamento de Disciplinas</h1>
        <p>Crie e visualize as disciplinas do sistema</p>
      </div>

      <!-- Navega√ß√£o Breadcrumb -->
      <div class="nav-breadcrumb">
        <a href="{% url 'inicio' %}">üè† In√≠cio</a>
        <span>‚Üí</span>
        <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
        <span>‚Üí</span>
        <span>üìñ Disciplinas</span>
      </div>

      {% if messages %}
      <div class="messages">
        {% for message in messages %}
        <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="form-section">
        <h2>
          {% if editing %}Editar Disciplina{% else %}Criar Nova Disciplina{% endif %}
        </h2>
        <form method="post">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.disciplina_nome.id_for_label }}"
                >{{ form.disciplina_nome.label }}</label
              >
              {{ form.disciplina_nome }} {% if form.disciplina_nome.errors %}
              <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px">
                {% for error in form.disciplina_nome.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.disciplina_sigla.id_for_label }}">{{ form.disciplina_sigla.label }}</label>
              {{ form.disciplina_sigla }} {% if form.disciplina_sigla.errors %}
              <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px">
                {% for error in form.disciplina_sigla.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.disciplina_tipo.id_for_label }}">{{ form.disciplina_tipo.label }}</label>
              {{ form.disciplina_tipo }} {% if form.disciplina_tipo.errors %}
              <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px">
                {% for error in form.disciplina_tipo.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.curso.id_for_label }}">{{ form.curso.label }}</label>
              {{ form.curso }} {% if form.curso.errors %}
              <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px">
                {% for error in form.curso.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.professor.id_for_label }}">{{ form.professor.label }}</label>
              {{ form.professor }} {% if form.professor.errors %}
              <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px">
                {% for error in form.professor.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.periodo_letivo.id_for_label }}">{{ form.periodo_letivo.label }}</label>
              {{ form.periodo_letivo }} {% if form.periodo_letivo.errors %}
              <div style="color: #dc3545; font-size: 0.875em; margin-top: 5px">
                {% for error in form.periodo_letivo.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          <button type="submit" class="btn">
            {% if editing %}Atualizar Disciplina{% else %}Criar Disciplina{% endif %}
          </button>
          {% if editing %}
          <a href="{% url 'gerenciar_disciplinas' %}" class="btn btn-secondary">Cancelar</a>
          {% endif %}
        </form>
      </div>

      {% if not editing %}
      <div class="form-section">
        <h2>Disciplinas Cadastradas</h2>
        <div class="item-count">
          Total de disciplinas: {{ disciplinas.count }}
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome da Disciplina</th>
              <th>Sigla</th>
              <th>Tipo</th>
              <th>Curso</th>
              <th>Professor</th>
              <th>Per√≠odo Letivo</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for disciplina in disciplinas %}
            <tr>
              <td>{{ disciplina.id }}</td>
              <td>{{ disciplina.disciplina_nome }}</td>
              <td>{{ disciplina.disciplina_sigla }}</td>
              <td>{{ disciplina.disciplina_tipo }}</td>
              <td>{{ disciplina.curso.curso_nome }}</td>
              <td>{{ disciplina.professor }}</td>
              <td>{{ disciplina.periodo_letivo }}</td>
              <td>
                <a
                  href="{% url 'editar_disciplina' disciplina.id %}"
                  class="btn-action btn-edit"
                  >‚úèÔ∏è Editar</a
                >
                <button
                  onclick="confirmarExclusao({{ disciplina.id }}, '{{ disciplina.disciplina_nome }}')"
                  class="btn-action btn-delete"
                >
                  üóëÔ∏è Excluir
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px">
                Nenhuma disciplina encontrada.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="modal-overlay" class="modal-overlay">
      <div class="modal">
        <div class="modal-header danger">
          <h3>Confirmar Exclus√£o</h3>
        </div>
        <div class="modal-content">
          <p id="modal-message">
            Tem certeza que deseja excluir esta disciplina? Esta a√ß√£o n√£o poder√°
            ser desfeita.
          </p>
          <div class="modal-actions">
            <button
              onclick="fecharModal()"
              class="btn-action"
              style="background: #6c757d; color: white"
            >
              Cancelar
            </button>
            <button onclick="excluirItem()" class="btn-action btn-delete">
              Excluir
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Vari√°vel global para controle do modal de exclus√£o
      let itemParaExcluir = null;

      // Fun√ß√£o para abrir modal de exclus√£o - padr√£o igual ao de cursos
      function confirmarExclusao(id, nome) {
        itemParaExcluir = id;
        document.getElementById(
          "modal-message"
        ).textContent = `Tem certeza que deseja excluir a disciplina "${nome}"? Esta a√ß√£o n√£o poder√° ser desfeita.`;
        document.getElementById("modal-overlay").classList.add("active");
      }

      // Fun√ß√£o para fechar modal de exclus√£o - padr√£o igual ao de cursos
      function fecharModal() {
        document.getElementById("modal-overlay").classList.remove("active");
        itemParaExcluir = null;
      }

      // Fun√ß√£o para confirmar exclus√£o - padr√£o igual ao de cursos
      function excluirItem() {
        if (!itemParaExcluir) return;

        fetch(`/excluir-disciplina/${itemParaExcluir}/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]")
              .value,
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert(data.message || "Disciplina exclu√≠da com sucesso!");
              location.reload();
            } else {
              alert(data.error || "Erro ao excluir disciplina.");
            }
          })
          .catch((error) => {
            console.error("Erro:", error);
            alert("Erro ao excluir disciplina.");
          })
          .finally(() => {
            fecharModal();
          });
      }

      // Fechar modal de exclus√£o ao clicar fora dele
      document
        .getElementById("modal-overlay")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            fecharModal();
          }
        });

      // Fechar modal com tecla Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          fecharModal();
        }
      });
    </script>
  </body>
</html>
