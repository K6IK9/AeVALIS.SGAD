{% load user_tags %} {% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IF SADD - Gerenciar Per√≠odos</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Gerenciamento de Per√≠odos Letivos</h1>
        <p>Crie e visualize os per√≠odos letivos do sistema</p>
      </div>

      <!-- Navega√ß√£o Breadcrumb -->
      <div class="nav-breadcrumb">
        <a href="{% url 'inicio' %}">üè† In√≠cio</a>
        <span>‚Üí</span>
        <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
        <span>‚Üí</span>
        <span>üìÖ Per√≠odos Letivos</span>
      </div>

      {% include "partials/messages.html" %}

      <div class="form-section">
        <h2>Criar Novo Per√≠odo Letivo</h2>
        <form method="post">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.nome.id_for_label }}"
                >{{ form.nome.label }}</label
              >
              {{ form.nome }} {% if form.nome.errors %}
              <div class="field-error">
                {% for error in form.nome.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.ano.id_for_label }}"
                >{{ form.ano.label }}</label
              >
              {{ form.ano }} {% if form.ano.errors %}
              <div class="field-error">
                {% for error in form.ano.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.semestre.id_for_label }}"
                >{{ form.semestre.label }}</label
              >
              {{ form.semestre }} {% if form.semestre.errors %}
              <div class="field-error">
                {% for error in form.semestre.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          {% if form.non_field_errors %}
          <div class="non-field-errors">
            {% for error in form.non_field_errors %} {{ error }} {% endfor %}
          </div>
          {% endif %}

          <div class="actions-end">
            <button type="submit" class="btn">‚úì Criar Per√≠odo Letivo</button>
          </div>
        </form>
      </div>

      <div class="form-section">
      <div class="section-header">
        <h2>üìÖ Per√≠odos Letivos Cadastrados ({{ periodos.count }})</h2>
      </div>

        <!-- Se√ß√£o de Filtros -->
        <div class="filters-section" id="filtersSection">
          <div class="filter-row">
            <div class="filter-group">
              <label for="searchPeriodoNome">Buscar por Nome:</label>
              <input type="text" id="searchPeriodoNome" placeholder="Digite o nome do per√≠odo">
            </div>
            
            <div class="filter-group">
              <label for="filterAno">Ano:</label>
              <select id="filterAno">
                <option value="">Todos os anos</option>
                {% for periodo in periodos %}
                  <option value="{{ periodo.ano }}">{{ periodo.ano }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <div class="filter-row">
            <div class="filter-group">
              <label for="filterSemestre">Semestre:</label>
              <select id="filterSemestre">
                <option value="">Todos os semestres</option>
                <option value="1">1¬∫ Semestre</option>
                <option value="2">2¬∫ Semestre</option>
              </select>
            </div>

            <div class="filter-group">
              <button type="button" onclick="clearFilters()" class="btn btn-clear">Limpar Filtros</button>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nome do Per√≠odo</th>
              <th>Ano</th>
              <th>Semestre</th>
              <th>Identifica√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for periodo in periodos %}
            <tr>
              <td>{{ periodo.id }}</td>
              <td>{{ periodo.nome }}</td>
              <td>{{ periodo.ano }}</td>
              <td>{{ periodo.get_semestre_display }}</td>
              <td><strong>{{ periodo.ano }}.{{ periodo.semestre }}</strong></td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-sm btn-secondary" title="Editar Per√≠odo"
                          onclick="editarPeriodo({{ periodo.id }}, '{{ periodo.nome }}', {{ periodo.ano }}, '{{ periodo.semestre }}')">
                    ‚úèÔ∏è Editar
                  </button>
                  <form method="post" action="{% url 'excluir_periodo' periodo.id %}" 
                        class="inline-form"
                        onsubmit="return confirm('Tem certeza que deseja excluir o per√≠odo \'{{ periodo.nome|escapejs }}\'?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir Per√≠odo">
                      üóëÔ∏è Excluir
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center-table">
                Nenhum per√≠odo letivo encontrado.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="editModal" class="modal-overlay">
      <div class="modal">
        <div class="modal-header">
          <h3>Editar Per√≠odo Letivo</h3>
        </div>
        <div class="modal-content">
          <form id="editForm" method="post">
            {% csrf_token %}
            <div class="form-row">
              <div class="form-group">
                <label for="edit_nome">Nome do Per√≠odo:</label>
                <input
                  type="text"
                  id="edit_nome"
                  name="nome"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="edit_ano">Ano:</label>
                <input
                  type="number"
                  id="edit_ano"
                  name="ano"
                  class="form-control"
                  min="2000"
                  max="2099"
                  required
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="edit_semestre">Semestre:</label>
                <select
                  id="edit_semestre"
                  name="semestre"
                  class="form-control"
                  required
                >
                  <option value="1">1¬∫ Semestre</option>
                  <option value="2">2¬∫ Semestre</option>
                </select>
              </div>
            </div>
            <div class="actions-end">
              <button type="button" class="btn btn-secondary"
                      onclick="closeEditModal()">
                Cancelar
              </button>
              <button type="submit" class="btn">
                ‚úì Salvar Altera√ß√µes
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      // Vari√°veis globais para controle dos modais
      let currentEditId = null;

      // Fun√ß√£o para abrir modal de edi√ß√£o
      function editarPeriodo(id, nome, ano, semestre) {
        currentEditId = id;
        document.getElementById("edit_nome").value = nome;
        document.getElementById("edit_ano").value = ano;
        document.getElementById("edit_semestre").value = semestre;

        // Atualiza a action do formul√°rio
        document.getElementById("editForm").action = `/editar-periodo/${id}/`;

        document.getElementById("editModal").classList.add("active");
      }

      // Fun√ß√£o para fechar modal de edi√ß√£o
      function closeEditModal() {
        document.getElementById("editModal").classList.remove("active");
        currentEditId = null;
      }

      // Fechar modais ao clicar fora do modal
      document
        .getElementById("editModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeEditModal();
          }
        });

      // Fechar modais com tecla Escape
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          closeEditModal();
        }
      });

      // Fun√ß√£o para filtrar a tabela
      function filterTable() {
        const nomeFilter = document.getElementById('searchPeriodoNome').value.toLowerCase();
        const anoFilter = document.getElementById('filterAno').value;
        const semestreFilter = document.getElementById('filterSemestre').value;
        
        const tableRows = document.querySelectorAll('.data-table tbody tr');
        let visibleCount = 0;

        tableRows.forEach(row => {
          const cells = row.querySelectorAll('td');
          
          // Verifica se a linha tem c√©lulas (n√£o √© a linha "Nenhum per√≠odo encontrado")
          if (cells.length > 1) {
            const periodoNome = cells[1].textContent.toLowerCase(); // Nome
            const periodoAno = cells[2].textContent.trim(); // Ano
            const periodoSemestre = cells[3].textContent.toLowerCase(); // Semestre

            const nomeMatch = !nomeFilter || periodoNome.includes(nomeFilter);
            const anoMatch = !anoFilter || periodoAno === anoFilter;
            const semestreMatch = !semestreFilter || periodoSemestre.includes(semestreFilter + '¬∫');

            if (nomeMatch && anoMatch && semestreMatch) {
              row.style.display = '';
              visibleCount++;
            } else {
              row.style.display = 'none';
            }
          }
        });

        // Atualiza o contador
        const sectionHeader = document.querySelector('.section-header h2');
        if (sectionHeader) {
          sectionHeader.textContent = `üìÖ Per√≠odos Letivos Cadastrados (${visibleCount})`;
        }

        // Mostra mensagem se nenhum resultado for encontrado
        const emptyRow = document.querySelector('tr td[colspan]');
        if (emptyRow) {
          emptyRow.parentElement.style.display = visibleCount === 0 ? '' : 'none';
        }
      }

      // Fun√ß√£o para limpar filtros
      function clearFilters() {
        document.getElementById('searchPeriodoNome').value = '';
        document.getElementById('filterAno').value = '';
        document.getElementById('filterSemestre').value = '';
        filterTable();
      }

      // Adiciona event listeners aos campos de filtro
      document.addEventListener('DOMContentLoaded', function() {
        const searchPeriodoNome = document.getElementById('searchPeriodoNome');
        const filterAno = document.getElementById('filterAno');
        const filterSemestre = document.getElementById('filterSemestre');

        if (searchPeriodoNome) searchPeriodoNome.addEventListener('input', filterTable);
        if (filterAno) filterAno.addEventListener('change', filterTable);
        if (filterSemestre) filterSemestre.addEventListener('change', filterTable);
      });

      // Tratar envio do formul√°rio de edi√ß√£o via AJAX
      document.getElementById("editForm").onsubmit = function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        fetch(this.action, {
          method: "POST",
          body: formData,
          headers: {
            "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
          },
        })
          .then((response) => {
            if (response.ok) {
              alert("Per√≠odo editado com sucesso!");
              location.reload();
            } else {
              alert("Erro ao editar per√≠odo");
            }
          })
          .catch((error) => {
            console.error("Erro:", error);
            alert("Erro ao editar per√≠odo");
          });
      };
    </script>
    
    <!-- Script global para funcionalidades de gerenciamento -->
    <script src="{% static 'js/gerenciar-global.js' %}"></script>
  </body>
</html>
