{% load user_tags %} {% load static %}

<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% if brand.enabled %}{{ brand.name_short }}{% else %}{{ brand.name_old }}{% endif %} - Gerenciar Per√≠odos</title>

    <!-- Favicons -->
    {% include 'partials/favicon_meta.html' %}

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Gerenciamento de Per√≠odos Letivos</h1>
        <p>Crie e visualize os per√≠odos letivos do sistema</p>
      </div>

      <!-- Navega√ß√£o Breadcrumb -->
      <div class="nav-breadcrumb">
        <a href="{% url 'inicio' %}">üè† In√≠cio</a>
        <span>‚Üí</span>
        <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
        <span>‚Üí</span>
        <span>üìÖ Per√≠odos Letivos</span>
      </div>

      {% include "partials/messages.html" %}

      <div class="form-section">
        <h2>
          {% if editing %}‚úèÔ∏è Editar Per√≠odo Letivo{% else %}‚ûï Criar Novo Per√≠odo Letivo{% endif %}
        </h2>
        <form method="post">
          {% csrf_token %}
          <div class="form-row">
            <div class="form-group">
              <label for="{{ form.nome.id_for_label }}"
                >{{ form.nome.label }}</label
              >
              {{ form.nome }} {% if form.nome.errors %}
              <div class="field-error">
                {% for error in form.nome.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.ano.id_for_label }}"
                >{{ form.ano.label }}</label
              >
              {{ form.ano }} {% if form.ano.errors %}
              <div class="field-error">
                {% for error in form.ano.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>

            <div class="form-group">
              <label for="{{ form.semestre.id_for_label }}"
                >{{ form.semestre.label }}</label
              >
              {{ form.semestre }} {% if form.semestre.errors %}
              <div class="field-error">
                {% for error in form.semestre.errors %} {{ error }} {% endfor %}
              </div>
              {% endif %}
            </div>
          </div>

          {% if form.non_field_errors %}
          <div class="non-field-errors">
            {% for error in form.non_field_errors %} {{ error }} {% endfor %}
          </div>
          {% endif %}

          <div class="actions-end">
            <a href="{% if editing %}{% url 'gerenciar_periodos' %}{% else %}{% url 'admin_hub' %}{% endif %}"
              class="btn btn-secondary">
              ‚Üê Cancelar
            </a>
            <button type="submit" class="btn">
              {% if editing %}‚úì Salvar Altera√ß√µes{% else %}‚úì Criar Per√≠odo Letivo{% endif %}
            </button>
          </div>
        </form>
      </div>

      {% if not editing %}
      <!-- Se√ß√£o de Filtros -->
      <div class="filters-section" id="filtersSection">
        <div class="filter-row">
          <div class="filter-group">
            <label for="searchPeriodoNome">Buscar por Nome:</label>
            <input type="text" id="searchPeriodoNome" class="form-control" placeholder="Digite o nome do per√≠odo">
          </div>
          
          <div class="filter-group">
            <label for="filterAno">Ano:</label>
            <select id="filterAno" class="form-control">
              <option value="">Todos os anos</option>
              {% regroup periodos by ano as anos_grupo %}
              {% for ano in anos_grupo %}
                <option value="{{ ano.grouper }}">{{ ano.grouper }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="filter-row">
          <div class="filter-group">
            <label for="filterSemestre">Semestre:</label>
            <select id="filterSemestre" class="form-control">
              <option value="">Todos os semestres</option>
              {% regroup periodos by semestre as semestres_grupo %}
              {% for semestre in semestres_grupo %}
                <option value="{{ semestre.grouper }}">{{ semestre.grouper }}¬∫ Semestre</option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <button type="button" onclick="clearFilters()" class="btn-filter">Limpar Filtros</button>
          </div>
        </div>
      </div>

      <!-- Lista de Per√≠odos Letivos -->
      <div class="form-section">
        <div class="section-header">
          <h2>üìÖ Per√≠odos Letivos Cadastrados ({{ periodos.count }})</h2>
        </div>
        
        <div class="table-responsive">
          <table class="data-table">
          <thead>
            <tr>
              <th>Nome do Per√≠odo</th>
              <th>Ano</th>
              <th>Semestre</th>
              <th>Identifica√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for periodo in periodos %}
            <tr>
              <td>{{ periodo.nome }}</td>
              <td>{{ periodo.ano }}</td>
              <td>{{ periodo.get_semestre_display }}</td>
              <td><strong>{{ periodo.ano }}.{{ periodo.semestre }}</strong></td>
              <td>
                <div class="btn-group">
                  <a href="{% url 'editar_periodo_simples' periodo.id %}" class="btn btn-sm btn-secondary" title="Editar Per√≠odo">
                    ‚úèÔ∏è Editar
                  </a>
                  <form method="post" action="{% url 'excluir_periodo' periodo.id %}" 
                        class="inline-form"
                        onsubmit="return confirm('Tem certeza que deseja excluir o per√≠odo \'{{ periodo.nome|escapejs }}\'?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir Per√≠odo">
                      üóëÔ∏è Excluir
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center-table">
                Nenhum per√≠odo letivo encontrado.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Script global para funcionalidades de gerenciamento -->
    <script src="{% static 'js/gerenciar-global.js' %}"></script>
    
    <script>
      // Adiciona event listeners aos campos de filtro quando o DOM carregar
      document.addEventListener('DOMContentLoaded', function() {
        // Fun√ß√£o para filtrar a tabela de per√≠odos
        function filterTablePeriodos() {
          const searchFilter = document.getElementById('searchPeriodoNome')?.value.toLowerCase() || '';
          const anoFilter = document.getElementById('filterAno')?.value || '';
          const semestreFilter = document.getElementById('filterSemestre')?.value || '';
          
          const tableRows = document.querySelectorAll('.data-table tbody tr');
          let visibleCount = 0;

          tableRows.forEach(row => {
            const cells = row.querySelectorAll('td');
            
            // Verifica se a linha tem c√©lulas (n√£o √© a linha "Nenhum per√≠odo encontrado")
            if (cells.length > 1) {
              const periodoNome = cells[1].textContent.toLowerCase(); // Nome
              const periodoAno = cells[2].textContent.trim(); // Ano
              const periodoSemestre = cells[3].textContent.trim(); // Semestre (ex: "1¬∫ Semestre")
              
              // Busca por nome
              const searchMatch = !searchFilter || periodoNome.includes(searchFilter);
              
              // Filtro por ano
              const anoMatch = !anoFilter || periodoAno === anoFilter;
              
              // Filtro por semestre - compara com o texto completo
              let semestreMatch = true;
              if (semestreFilter) {
                // Cria o texto completo esperado (ex: "1¬∫ Semestre")
                const expectedSemestre = semestreFilter + '¬∫ Semestre';
                semestreMatch = periodoSemestre === expectedSemestre;
              }

              if (searchMatch && anoMatch && semestreMatch) {
                row.style.display = '';
                visibleCount++;
              } else {
                row.style.display = 'none';
              }
            }
          });

          // Atualiza o contador no t√≠tulo
          const sectionTitle = document.querySelector('.section-header h2');
          if (sectionTitle) {
            sectionTitle.textContent = `üìÖ Per√≠odos Letivos Cadastrados (${visibleCount})`;
          }

          // Mostra/esconde mensagem de "nenhum per√≠odo encontrado"
          const emptyRow = document.querySelector('tr td[colspan]');
          if (emptyRow) {
            if (visibleCount === 0) {
              emptyRow.parentElement.style.display = '';
              emptyRow.textContent = 'Nenhum per√≠odo letivo encontrado com os filtros aplicados.';
            } else {
              emptyRow.parentElement.style.display = 'none';
            }
          } else if (visibleCount === 0) {
            // Se n√£o existe uma mensagem de empty state, cria uma tempor√°ria
            const tbody = document.querySelector('.data-table tbody');
            let noResultsRow = tbody?.querySelector('.no-results-row');
            
            if (!noResultsRow && tbody) {
              noResultsRow = document.createElement('tr');
              noResultsRow.className = 'no-results-row';
              noResultsRow.innerHTML = '<td colspan="5" style="text-align: center; padding: 20px; color: #666;">Nenhum per√≠odo letivo encontrado com os filtros aplicados.</td>';
              tbody.appendChild(noResultsRow);
            }
            if (noResultsRow) noResultsRow.style.display = '';
          } else {
            // Remove mensagem tempor√°ria se existir
            const noResultsRow = document.querySelector('.no-results-row');
            if (noResultsRow) {
              noResultsRow.style.display = 'none';
            }
          }
        }

        // Fun√ß√£o para limpar filtros
        function clearFilters() {
          const searchInput = document.getElementById('searchPeriodoNome');
          const anoSelect = document.getElementById('filterAno');
          const semestreSelect = document.getElementById('filterSemestre');
          
          if (searchInput) searchInput.value = '';
          if (anoSelect) anoSelect.value = '';
          if (semestreSelect) semestreSelect.value = '';
          
          filterTablePeriodos();
        }

        // Torna clearFilters dispon√≠vel globalmente para o onclick
        window.clearFilters = clearFilters;

        // Configura event listeners nos campos de filtro
        const searchPeriodoNome = document.getElementById('searchPeriodoNome');
        const filterAno = document.getElementById('filterAno');
        const filterSemestre = document.getElementById('filterSemestre');

        if (searchPeriodoNome) searchPeriodoNome.addEventListener('input', filterTablePeriodos);
        if (filterAno) filterAno.addEventListener('change', filterTablePeriodos);
        if (filterSemestre) filterSemestre.addEventListener('change', filterTablePeriodos);
      });
    </script>
  </body>
</html>
