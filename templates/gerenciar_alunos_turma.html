{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IF SADD - Gerenciar Alunos da Turma</title>

    <link rel="stylesheet" href="{% static 'css/global.css' %}" />
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
</head>

<body>
    <div class="container">
        <!-- Bot√£o Voltar -->
        <a href="{% url 'gerenciar_turmas' %}" class="back-button">‚Üê Voltar √†s Turmas</a>

        <!-- Header da p√°gina -->
        <div class="header">
            <h1>Gerenciar Alunos da Turma</h1>
            <div class="turma-info">
                <h2>{{ turma.disciplina.disciplina_nome }}</h2>
                <p><strong>Professor:</strong> {{ turma.disciplina.professor.user.get_full_name }}</p>
                <p><strong>Per√≠odo:</strong> {{ turma.disciplina.periodo_letivo.ano }}.{{ turma.disciplina.periodo_letivo.semestre }} | <strong>Turno:</strong> {{ turma.get_turno_display }}</p>
                <p><strong>C√≥digo:</strong> {{ turma.codigo_turma }}</p>
            </div>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
            <span>‚Üí</span>
            <a href="{% url 'gerenciar_turmas' %}">üìö Turmas</a>
            <span>‚Üí</span>
            <span>üë• Gerenciar Alunos</span>
        </div>

        <!-- Mensagens -->
        {% include "partials/messages.html" %}

        <!-- Estat√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ total_alunos }}</div>
                <div class="stat-label">Total de Alunos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ alunos_matriculados }}</div>
                <div class="stat-label">Matriculados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ alunos_disponiveis }}</div>
                <div class="stat-label">Dispon√≠veis</div>
            </div>
        </div>

        <!-- Se√ß√£o de Gerenciamento de Alunos -->
        <div class="form-section">
            <h2>üë• Selecionar Alunos para Matr√≠cula/Desmatr√≠cula</h2>
            
            <form method="post" id="form-alunos">
                {% csrf_token %}
                <div class="alunos-controls">
                    <div class="alunos-search-bar">
                        <input type="text" id="searchAlunos" class="form-control" 
                               placeholder="üîç Buscar por nome, matr√≠cula ou email..." 
                               autocomplete="off">
                    </div>
                    
                    <div class="alunos-actions">
                        <button type="button" class="btn-small btn-secondary" onclick="selecionarTodosAlunos()">
                            ‚úÖ Selecionar Todos
                        </button>
                        <button type="button" class="btn-small btn-secondary" onclick="limparSelecaoAlunos()">
                            ‚ùå Limpar Sele√ß√£o
                        </button>
                        <button type="submit" name="acao" value="matricular" class="btn-small btn-success"
                                onclick="return confirmarAcao('matricular')" title="Matricular Selecionados">
                            ‚ûï Matricular
                        </button>
                        <button type="submit" name="acao" value="desmatricular" class="btn-small btn-danger"
                                onclick="return confirmarAcao('desmatricular')" title="Desmatricular Selecionados">
                            ‚ûñ Desmatricular
                        </button>
                        <span class="alunos-counter" id="alunosCounter">
                            <strong>0</strong> aluno(s) selecionado(s)
                        </span>
                    </div>
                </div>

                <!-- Container de alunos com cards -->
                <div class="alunos-grid-container" id="alunosContainer">
                    {% if alunos %}
                    {% for aluno in alunos %}
                    <div class="aluno-card {% if aluno.matriculado %}matriculado{% endif %}" 
                         data-aluno-info="{{ aluno.nome|lower }} {{ aluno.username|lower }} {{ aluno.email|lower }}"
                         onclick="toggleCardAluno(this)">
                        <div class="aluno-card-checkbox">
                            <input type="checkbox" name="alunos_selecionados" value="{{ aluno.id }}"
                                   id="aluno_{{ aluno.id }}" />
                        </div>

                        <div class="aluno-card-info">
                            <label for="aluno_{{ aluno.id }}" class="aluno-card-nome">
                                {{ aluno.nome }}
                            </label>
                            <div class="aluno-card-detalhes">
                                <span class="aluno-card-username">@{{ aluno.username }}</span>
                                <span class="aluno-card-email">üìß {{ aluno.email }}</span>
                            </div>
                        </div>

                        <div class="aluno-card-status">
                            {% if aluno.matriculado %}
                            <span class="status-badge matriculado">‚úÖ Matriculado</span>
                            {% else %}
                            <span class="status-badge disponivel">‚≠ï Dispon√≠vel</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="empty-alunos-message">
                        <p>üì≠ Nenhum aluno cadastrado no sistema.</p>
                    </div>
                    {% endif %}
                </div>
                
                <div id="noAlunosMessage" class="empty-alunos-message" style="display: none;">
                    <p>üîç Nenhum aluno encontrado com os crit√©rios de busca.</p>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ============================================
        // TOGGLE DE CARD DE ALUNO (CLIQUE NO CARD)
        // ============================================
        function toggleCardAluno(card) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                
                // Toggle classe selected
                if (checkbox.checked) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
                
                atualizarContadorAlunos();
            }
        }

        // ============================================
        // CONTADOR DE ALUNOS SELECIONADOS
        // ============================================
        function atualizarContadorAlunos() {
            const checkboxes = document.querySelectorAll('.aluno-card input[type="checkbox"]');
            const selecionados = Array.from(checkboxes).filter(cb => cb.checked).length;
            const counter = document.getElementById('alunosCounter');
            if (counter) {
                counter.innerHTML = `<strong>${selecionados}</strong> aluno(s) selecionado(s)`;
            }
        }

        // ============================================
        // SELECIONAR TODOS OS ALUNOS VIS√çVEIS
        // ============================================
        function selecionarTodosAlunos() {
            const cards = document.querySelectorAll('.aluno-card');
            const checkboxes = document.querySelectorAll('.aluno-card input[type="checkbox"]');
            
            // Seleciona apenas os alunos vis√≠veis
            cards.forEach((card, index) => {
                if (card.style.display !== 'none') {
                    checkboxes[index].checked = true;
                    card.classList.add('selected');
                }
            });
            
            atualizarContadorAlunos();
        }

        // ============================================
        // LIMPAR SELE√á√ÉO DE ALUNOS
        // ============================================
        function limparSelecaoAlunos() {
            const checkboxes = document.querySelectorAll('.aluno-card input[type="checkbox"]');
            const cards = document.querySelectorAll('.aluno-card');
            
            checkboxes.forEach(cb => cb.checked = false);
            cards.forEach(card => card.classList.remove('selected'));
            
            atualizarContadorAlunos();
        }

        // ============================================
        // FILTRAR ALUNOS POR BUSCA
        // ============================================
        function filtrarAlunos() {
            const searchTerm = document.getElementById('searchAlunos').value.toLowerCase();
            const cards = document.querySelectorAll('.aluno-card');
            const noMessage = document.getElementById('noAlunosMessage');
            const container = document.getElementById('alunosContainer');
            let visibleCount = 0;

            cards.forEach(card => {
                const alunoInfo = card.getAttribute('data-aluno-info');
                
                if (!searchTerm || alunoInfo.includes(searchTerm)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Mostra/esconde mensagem de "nenhum aluno encontrado"
            if (noMessage && container) {
                if (visibleCount === 0) {
                    container.style.display = 'none';
                    noMessage.style.display = 'block';
                } else {
                    container.style.display = 'grid';
                    noMessage.style.display = 'none';
                }
            }
        }

        // ============================================
        // CONFIRMAR A√á√ÉO ANTES DE SUBMETER
        // ============================================
        function confirmarAcao(acao) {
            const selecionados = document.querySelectorAll('.aluno-card input[type="checkbox"]:checked');
            
            if (selecionados.length === 0) {
                alert('‚ö†Ô∏è Selecione pelo menos um aluno para realizar a a√ß√£o.');
                return false;
            }
            
            const mensagem = acao === 'matricular' 
                ? `‚úÖ Confirma a matr√≠cula de ${selecionados.length} aluno(s)?`
                : `‚ùå Confirma a desmatr√≠cula de ${selecionados.length} aluno(s)?`;
            
            return confirm(mensagem);
        }

        // ============================================
        // INICIALIZA√á√ÉO
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchAlunos');
            const checkboxes = document.querySelectorAll('.aluno-card input[type="checkbox"]');
            
            // Event listener para busca com debounce
            if (searchInput) {
                let timeoutId;
                searchInput.addEventListener('input', function() {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        filtrarAlunos();
                    }, 300);
                });
            }
            
            // Event listener para checkboxes (atualizar contador)
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const card = this.closest('.aluno-card');
                    if (this.checked) {
                        card.classList.add('selected');
                    } else {
                        card.classList.remove('selected');
                    }
                    atualizarContadorAlunos();
                });
            });
            
            // Inicializar cards j√° marcados como selected
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.closest('.aluno-card').classList.add('selected');
                }
            });
            
            // Atualizar contador inicial
            atualizarContadorAlunos();
        });
    </script>
</body>

</html>