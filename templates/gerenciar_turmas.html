{% load user_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IF SADD - Gerenciar Turmas</title>

  <link rel="stylesheet" href="{% static 'css/global.css' %}" />
  <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
  <link rel="stylesheet" href="{% static 'css/gerenciar_turmas.css' %}" />
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Gerenciamento de Turmas</h1>
      <p>Crie e visualize as turmas do sistema por per√≠odo letivo</p>
    </div>

    <!-- Navega√ß√£o Breadcrumb -->
    <div class="nav-breadcrumb">
      <a href="{% url 'inicio' %}">üè† In√≠cio</a>
      <span>‚Üí</span>
      <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
      <span>‚Üí</span>
      <span>üìö Turmas</span>
    </div>

    {% if messages %}
    <div class="messages">
      {% for message in messages %}
      <div class="message {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Formul√°rio de Cria√ß√£o de Turma -->
    <div class="form-section">
      <form method="post">
        <h2>Criar Nova Turma</h2>
        {% csrf_token %}

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.disciplina.id_for_label }}">{{ form.disciplina.label }}</label>
            {{ form.disciplina }}
            {% if form.disciplina.errors %}
            <div class="error-text">
              {% for error in form.disciplina.errors %} {{ error }} {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.professor.id_for_label }}">{{ form.professor.label }}</label>
            {{ form.professor }}
            {% if form.professor.errors %}
            <div class="error-text">
              {% for error in form.professor.errors %} {{ error }} {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.periodo_letivo.id_for_label }}">{{ form.periodo_letivo.label }}</label>
            {{ form.periodo_letivo }}
            {% if form.periodo_letivo.errors %}
            <div class="error-text">
              {% for error in form.periodo_letivo.errors %} {{ error }} {% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.turno.id_for_label }}">{{ form.turno.label }}</label>
            {{ form.turno }}
            {% if form.turno.errors %}
            <div class="error-text">
              {% for error in form.turno.errors %} {{ error }} {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        {% if form.non_field_errors %}
        <div class="error-text-bottom">
          {% for error in form.non_field_errors %} {{ error }} {% endfor %}
        </div>
        {% endif %}

        <div class="form-actions">
          <button type="submit" class="btn btn-success">Criar Turma</button>
        </div>
      </form>
    </div>

    <!-- Se√ß√£o de Filtros e Listagem -->
    <div class="form-section">
      <div class="section-header">
        <h2>Turmas Cadastradas</h2>
        <div class="section-actions">
          <span class="turma-count">Total: {{ turmas|length }} turma{{ turmas|length|pluralize }}</span>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters-section">
        <h3 class="filters-title">Filtros e Busca</h3>
        <div class="filter-row">
          <div class="filter-group">
            <label for="filtro-periodo">Filtrar por Per√≠odo Letivo:</label>
            <select id="filtro-periodo" class="form-control" onchange="filtrarTurmas()">
              <option value="">Todos os per√≠odos</option>
              {% for periodo in periodos_letivos %}
              <option value="{{ periodo.id }}">{{ periodo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <label for="filtro-disciplina">Filtrar por Disciplina:</label>
            <select id="filtro-disciplina" class="form-control" onchange="filtrarTurmas()">
              <option value="">Todas as disciplinas</option>
              {% for disciplina in disciplinas %}
              <option value="{{ disciplina.id }}">
                {{ disciplina.disciplina_nome }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <label for="filtro-professor">Filtrar por Professor:</label>
            <select id="filtro-professor" class="form-control" onchange="filtrarTurmas()">
              <option value="">Todos os professores</option>
              {% for professor in professores %}
              <option value="{{ professor.id }}">
                {{ professor.user.get_full_name }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="filter-group">
            <button type="button" class="btn-filter" onclick="aplicarFiltros()">üîç Pesquisar</button>
          </div>

          <div class="filter-group">
            <button type="button" class="btn-filter" onclick="limparFiltros()">
              Limpar Filtros
            </button>
          </div>
        </div>
      </div>

      <!-- Tabela de Turmas -->
      <div class="table-container">
        <div class="table-responsive">
          <table class="turmas-table data-table" id="tabela-turmas">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Disciplina</th>
                <th>Professor</th>
                <th>Per√≠odo</th>
                <th>Turno</th>
                <th>Status</th>
                <th>Matr√≠culas</th>
                <th>Data Cria√ß√£o</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              {% if turmas %}
              {% for turma in turmas %}
              <tr data-periodo="{{ turma.periodo_letivo.id }}" data-disciplina="{{ turma.disciplina.id }}"
                data-professor="{{ turma.professor.id }}">
                <td>{{ turma.codigo_turma }}</td>
                <td>{{ turma.disciplina.disciplina_nome }}</td>
                <td>{{ turma.professor.user.get_full_name }}</td>
                <td>{{ turma.periodo_letivo }}</td>
                <td>
                  <span class="turno-badge">{{ turma.get_turno_display }}</span>
                </td>
                <td>
                  <span class="status-badge status-{{ turma.status|lower }}">
                    {{ turma.get_status_display }}
                  </span>
                </td>
                <td>
                  {{ turma.alunos.count }} aluno{{ turma.alunos.count|pluralize }}
                </td>
                <td>{{ turma.data_criacao|date:"d/m/Y" }}</td>
                <td>
                  <div class="btn-group">
                    <a href="{% url 'gerenciar_alunos_turma' turma.id %}" 
                       class="btn btn-sm btn-secondary" title="Gerenciar Alunos">
                      üë• Alunos
                    </a>
                    <form method="post" action="{% url 'excluir_turma' turma.id %}" 
                          class="inline-form"
                          onsubmit="return confirm('Tem certeza que deseja excluir a turma \'{{ turma.disciplina.disciplina_nome }} - {{ turma.professor.user.get_full_name|escapejs }}\'?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-danger" title="Excluir Turma">
                        üóëÔ∏è Excluir
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr>
                <td colspan="9" class="empty-state">
                  <h3>Nenhuma turma encontrada</h3>
                  <p>N√£o h√° turmas cadastradas no per√≠odo selecionado.</p>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  </div>

  <script>
    let turmaAtualId = null;
    let alunosData = [];

    // Fun√ß√£o para gerenciar alunos de uma turma
    function gerenciarAlunos(turmaId, disciplinaNome, professorNome) {
      turmaAtualId = turmaId;

      // Atualizar informa√ß√µes da turma no modal
      document.getElementById("turma-nome").textContent = disciplinaNome;
      document.getElementById("turma-professor").textContent = `Professor: ${professorNome}`;

      // Mostrar modal
      document.getElementById("modal-alunos-overlay").classList.add("active");

      // Carregar alunos
      carregarAlunos();
    }

    // Fun√ß√£o para carregar alunos via AJAX
    function carregarAlunos() {
      const container = document.getElementById("alunos-list");

      fetch(`/admin/turmas/${turmaAtualId}/alunos/`)
        .then((response) => response.json())
        .then((data) => {
          alunosData = data.alunos;
          renderizarAlunos();
        })
        .catch((error) => {
          console.error("Erro ao carregar alunos:", error);
          container.innerHTML = '<div class="empty-state">Erro ao carregar alunos.</div>';
        });
    }

    function renderizarAlunos() {
      const container = document.getElementById("alunos-list");

      if (alunosData.length === 0) {
        container.innerHTML = `
                    <div class="empty-state">
                        Nenhum aluno encontrado
                    </div>
                `;
        return;
      }

      container.innerHTML = alunosData
        .map(
          (aluno) => `
                <div class="aluno-item">
                    <input type="checkbox" class="aluno-checkbox" value="${aluno.id}" 
                           ${aluno.matriculado ? "checked" : ""} 
                           onchange="toggleAluno(${aluno.id}, this.checked)">
                    <div class="aluno-info">
                        <div class="aluno-nome">${aluno.nome}</div>
                        <div class="aluno-matricula">Matr√≠cula: ${aluno.matricula}</div>
                    </div>
                    <div class="aluno-status ${aluno.matriculado ? "status-matriculado" : "status-disponivel"}">
                        ${aluno.matriculado ? "Matriculado" : "Dispon√≠vel"}
                    </div>
                </div>
            `
        )
        .join("");
    }

    // Fun√ß√£o para buscar alunos
    function buscarAlunos() {
      const termo = document.getElementById("busca-aluno").value.toLowerCase();
      const alunosFiltrados = alunosData.filter(
        (aluno) =>
          aluno.nome.toLowerCase().includes(termo) ||
          aluno.matricula.toString().includes(termo)
      );

      // Renderizar com alunos filtrados
      const container = document.getElementById("alunos-list");
      if (alunosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty-state">Nenhum aluno encontrado para os crit√©rios de busca.</div>';
        return;
      }

      container.innerHTML = alunosFiltrados
        .map(
          (aluno) => `
                <div class="aluno-item">
                    <input type="checkbox" class="aluno-checkbox" value="${aluno.id}" 
                           ${aluno.matriculado ? "checked" : ""} 
                           onchange="toggleAluno(${aluno.id}, this.checked)">
                    <div class="aluno-info">
                        <div class="aluno-nome">${aluno.nome}</div>
                        <div class="aluno-matricula">Matr√≠cula: ${aluno.matricula}</div>
                    </div>
                    <div class="aluno-status ${aluno.matriculado ? "status-matriculado" : "status-disponivel"}">
                        ${aluno.matriculado ? "Matriculado" : "Dispon√≠vel"}
                    </div>
                </div>
            `
        )
        .join("");
    }

    // Fun√ß√£o para alternar status de matr√≠cula de um aluno
    function toggleAluno(alunoId, matricular) {
      fetch(`/admin/turmas/${turmaAtualId}/toggle-aluno/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: JSON.stringify({
          aluno_id: alunoId,
          matricular: matricular,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Atualizar dados locais
            const aluno = alunosData.find((a) => a.id === alunoId);
            if (aluno) {
              aluno.matriculado = matricular;
            }
            renderizarAlunos();
          } else {
            alert(data.error || "Erro ao atualizar matr√≠cula do aluno.");
          }
        });
    }

    // Fun√ß√£o para matricular alunos selecionados
    function matricularSelecionados() {
      const checkboxes = document.querySelectorAll(".aluno-checkbox:checked");
      const alunosIds = Array.from(checkboxes).map((cb) => parseInt(cb.value));

      if (alunosIds.length === 0) {
        alert("Selecione pelo menos um aluno para matricular.");
        return;
      }

      fetch(`/admin/turmas/${turmaAtualId}/matricular-lote/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: JSON.stringify({
          alunos_ids: alunosIds,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert(`${data.count} aluno(s) matriculado(s) com sucesso.`);
            carregarAlunos();
          } else {
            alert(data.error || "Erro ao matricular alunos.");
          }
        });
    }

    // Fun√ß√£o para desmatricular alunos selecionados
    function desmatricularSelecionados() {
      const checkboxes = document.querySelectorAll(".aluno-checkbox:checked");
      const alunosIds = Array.from(checkboxes).map((cb) => parseInt(cb.value));

      if (alunosIds.length === 0) {
        alert("Selecione pelo menos um aluno para desmatricular.");
        return;
      }

      if (!confirm(`Desmatricular ${alunosIds.length} aluno(s) selecionado(s)?`)) {
        return;
      }

      fetch(`/admin/turmas/${turmaAtualId}/desmatricular-lote/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: JSON.stringify({
          alunos_ids: alunosIds,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert(`${data.count} aluno(s) desmatriculado(s) com sucesso.`);
            carregarAlunos();
          } else {
            alert(data.error || "Erro ao desmatricular alunos.");
          }
        });
    }

    // Fun√ß√£o para fechar modal de alunos
    function fecharModalAlunos() {
      document.getElementById("modal-alunos-overlay").classList.remove("active");
      turmaAtualId = null;
      alunosData = [];

      // Recarregar a p√°gina para atualizar contadores
      location.reload();
    }
  </script>

  <!-- Script global de gerenciamento -->
  <script src="{% static 'js/gerenciar-global.js' %}"></script>

  <!-- Scripts espec√≠ficos da p√°gina -->
  <script>
    // Usar as fun√ß√µes globais, mantendo apenas as espec√≠ficas da p√°gina
    
    // Fun√ß√£o para filtrar turmas - espec√≠fica desta p√°gina
    function filtrarTurmas() {
      const periodo = document.getElementById("filtro-periodo").value;
      const disciplina = document.getElementById("filtro-disciplina").value;
      const professor = document.getElementById("filtro-professor").value;

      const linhas = document.querySelectorAll("#tabela-turmas tbody tr");

      linhas.forEach((linha) => {
        let mostrar = true;

        if (periodo && linha.getAttribute("data-periodo") !== periodo) {
          mostrar = false;
        }

        if (disciplina && linha.getAttribute("data-disciplina") !== disciplina) {
          mostrar = false;
        }

        if (professor && linha.getAttribute("data-professor") !== professor) {
          mostrar = false;
        }

        linha.style.display = mostrar ? "" : "none";
      });
    }

    // Fun√ß√£o para aplicar filtros - usando a global aplicarFiltros como fallback
    function aplicarFiltros() {
      filtrarTurmas();
    }

    // Fun√ß√£o para limpar filtros espec√≠fica da p√°gina
    function limparFiltros() {
      document.getElementById("filtro-periodo").value = "";
      document.getElementById("filtro-disciplina").value = "";
      document.getElementById("filtro-professor").value = "";
      filtrarTurmas();
    }

    // Event listener para fechar modal clicando fora - mantendo para compatibilidade
    document.addEventListener("click", function (event) {
      const modals = document.querySelectorAll(".modal-overlay");
      modals.forEach((modal) => {
        if (event.target === modal) {
          modal.classList.remove("active");
        }
      });
    });
  </script>

</body>

</html>