{% load static %}
{% load user_tags %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if brand.enabled %}{{ brand.name_short }}{% else %}{{ brand.name_old }}{% endif %} - Gerenciar Turmas</title>

    <!-- Favicons -->
    {% include 'partials/favicon_meta.html' %}

  <link rel="stylesheet" href="{% static 'css/global.css' %}" />
  <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}" />
  <link rel="stylesheet" href="{% static 'css/gerenciar_turmas.css' %}" />
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Gerenciamento de Turmas</h1>
      <p>Crie e visualize as turmas do sistema por per√≠odo letivo</p>
    </div>

    <!-- Navega√ß√£o Breadcrumb -->
    <div class="nav-breadcrumb">
      <a href="{% url 'inicio' %}">üè† In√≠cio</a>
      <span>‚Üí</span>
      <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
      <span>‚Üí</span>
      <span>üìö Turmas</span>
    </div>

    {% include "partials/messages.html" %}

    <!-- Formul√°rio de Cria√ß√£o de Turma -->
    <div class="form-section">
      <h2>Criar Nova Turma</h2>
      
      <form method="post">
        {% csrf_token %}

        <div class="form-row">
          <div class="form-group">
            <label for="{{ form.disciplina.id_for_label }}">{{ form.disciplina.label }}</label>
            {{ form.disciplina }}
            {% if form.disciplina.help_text %}
            <div class="help-text">{{ form.disciplina.help_text }}</div>
            {% endif %}
            {% if form.disciplina.errors %}
            <div class="error-text">
              {% for error in form.disciplina.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>

          <div class="form-group">
            <label for="{{ form.turno.id_for_label }}">{{ form.turno.label }}</label>
            {{ form.turno }}
            {% if form.turno.errors %}
            <div class="error-text">
              {% for error in form.turno.errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Nota informativa -->
        <div class="info-box"
          style="background-color: #e3f2fd; padding: 10px; margin: 10px 0; border-left: 4px solid #2196F3;">
          <small>‚ÑπÔ∏è <strong>Informa√ß√£o:</strong> O professor e per√≠odo letivo s√£o automaticamente associados com base na
            disciplina selecionada.</small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success">Criar Turma</button>
        </div>
      </form>
    </div>

    <!-- Se√ß√£o de Filtros -->
    <h3 class="filters-title">üîç Filtros</h3>
    <form method="get" class="filters-section" id="filter-form">
      <div class="filter-row">
        <div class="filter-group">
          <label for="periodo">Filtrar por Per√≠odo Letivo:</label>
          <select id="periodo" name="periodo" class="form-control">
            <option value="">Todos os per√≠odos</option>
            {% for periodo in periodos_disponiveis %}
            <option value="{{ periodo.id }}" {% if filtro_periodo == periodo.id|stringformat:"s" %}selected{% endif %}>{{ periodo }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="filter-group">
          <label for="turno">Filtrar por Turno:</label>
          <select id="turno" name="turno" class="form-control">
            <option value="">Todos os turnos</option>
            <option value="matutino" {% if filtro_turno == "matutino" %}selected{% endif %}>Matutino</option>
            <option value="vespertino" {% if filtro_turno == "vespertino" %}selected{% endif %}>Vespertino</option>
            <option value="noturno" {% if filtro_turno == "noturno" %}selected{% endif %}>Noturno</option>
          </select>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-group">
          <label for="status">Filtrar por Status:</label>
          <select id="status" name="status" class="form-control">
            <option value="">Todos os status</option>
            <option value="aberta" {% if filtro_status == "aberta" %}selected{% endif %}>Aberta</option>
            <option value="fechada" {% if filtro_status == "fechada" %}selected{% endif %}>Fechada</option>
          </select>
        </div>

        <div class="filter-group filter-actions">
          <button type="submit" class="btn btn-primary">üîç Filtrar</button>
          <button type="button" onclick="window.location.href='?'" class="btn btn-clear">‚úñ Limpar Filtros</button>
        </div>
      </div>
    </form>

    <!-- Listagem de Turmas -->
    <div class="form-section">
      <div class="section-header">
        <h2>üìö Turmas Cadastradas ({{ turmas.paginator.count }})</h2>
      </div>

      {% if turmas %}
      <div class="table-scroll-hint">
        <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
      </div>
      <div class="table-responsive">
        <table class="turmas-table data-table" id="tabela-turmas">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Disciplina</th>
              <th>Professor</th>
              <th>Per√≠odo</th>
              <th>Turno</th>
              <th>Status</th>
              <th>Matr√≠culas</th>
              <th>Data Cria√ß√£o</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            {% for turma in turmas %}
            <tr data-periodo="{{ turma.disciplina.periodo_letivo.id }}" data-disciplina="{{ turma.disciplina.id }}"
              data-professor="{{ turma.disciplina.professor.id }}" data-turno="{{ turma.turno }}">
              <td>{{ turma.codigo_turma }}</td>
              <td>{{ turma.disciplina.disciplina_nome }}</td>
              <td>{{ turma.disciplina.professor.user.get_full_name }}</td>
              <td>{{ turma.disciplina.periodo_letivo }}</td>
              <td>
                <span class="turno-badge">{{ turma.get_turno_display }}</span>
              </td>
              <td>
                <span class="status-badge status-{{ turma.status|lower }}">
                  {{ turma.get_status_display }}
                </span>
              </td>
              <td>
                {{ turma.alunos.count }} aluno{{ turma.alunos.count|pluralize }}
              </td>
              <td>{{ turma.data_criacao|date:"d/m/Y" }}</td>
              <td>
                <div class="btn-group">
                  <a href="{% url 'gerenciar_alunos_turma' turma.id %}" class="btn btn-sm btn-secondary"
                    title="Gerenciar Alunos">
                    üë• Alunos
                  </a>
                  <form method="post" action="{% url 'excluir_turma' turma.id %}" class="inline-form"
                    onsubmit="return confirm('Tem certeza que deseja excluir a turma \'{{ turma.disciplina.disciplina_nome }} - {{ turma.professor.user.get_full_name|escapejs }}\'?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Excluir Turma">
                      üóëÔ∏è Excluir
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Pagina√ß√£o -->
      {% include 'partials/pagination.html' with page_obj=turmas %}

      {% else %}
      <div class="empty-state">
        <p class="empty-message">Nenhuma turma encontrada.</p>
        <p>N√£o h√° turmas cadastradas no sistema.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    let turmaAtualId = null;
    let alunosData = [];

    // Fun√ß√£o para gerenciar alunos de uma turma
    function gerenciarAlunos(turmaId, disciplinaNome, professorNome) {
      turmaAtualId = turmaId;

      // Atualizar informa√ß√µes da turma no modal
      document.getElementById("turma-nome").textContent = disciplinaNome;
      document.getElementById("turma-professor").textContent = `Professor: ${professorNome}`;

      // Mostrar modal
      document.getElementById("modal-alunos-overlay").classList.add("active");

      // Carregar alunos
      carregarAlunos();
    }

    // Fun√ß√£o para carregar alunos via AJAX
    function carregarAlunos() {
      const container = document.getElementById("alunos-list");

      fetch(`/admin/turmas/${turmaAtualId}/alunos/`)
        .then((response) => response.json())
        .then((data) => {
          alunosData = data.alunos;
          renderizarAlunos();
        })
        .catch((error) => {
          console.error("Erro ao carregar alunos:", error);
          container.innerHTML = '<div class="empty-state">Erro ao carregar alunos.</div>';
        });
    }

    function renderizarAlunos() {
      const container = document.getElementById("alunos-list");

      if (alunosData.length === 0) {
        container.innerHTML = `
                    <div class="empty-state">
                        Nenhum aluno encontrado
                    </div>
                `;
        return;
      }

      container.innerHTML = alunosData
        .map(
          (aluno) => `
                <div class="aluno-item">
                    <input type="checkbox" class="aluno-checkbox" value="${aluno.id}" 
                           ${aluno.matriculado ? "checked" : ""} 
                           onchange="toggleAluno(${aluno.id}, this.checked)">
                    <div class="aluno-info">
                        <div class="aluno-nome">${aluno.nome}</div>
                        <div class="aluno-matricula">Matr√≠cula: ${aluno.matricula}</div>
                    </div>
                    <div class="aluno-status ${aluno.matriculado ? "status-matriculado" : "status-disponivel"}">
                        ${aluno.matriculado ? "Matriculado" : "Dispon√≠vel"}
                    </div>
                </div>
            `
        )
        .join("");
    }

    // Fun√ß√£o para buscar alunos
    function buscarAlunos() {
      const termo = document.getElementById("busca-aluno").value.toLowerCase();
      const alunosFiltrados = alunosData.filter(
        (aluno) =>
          aluno.nome.toLowerCase().includes(termo) ||
          aluno.matricula.toString().includes(termo)
      );

      // Renderizar com alunos filtrados
      const container = document.getElementById("alunos-list");
      if (alunosFiltrados.length === 0) {
        container.innerHTML = '<div class="empty-state">Nenhum aluno encontrado para os crit√©rios de busca.</div>';
        return;
      }

      container.innerHTML = alunosFiltrados
        .map(
          (aluno) => `
                <div class="aluno-item">
                    <input type="checkbox" class="aluno-checkbox" value="${aluno.id}" 
                           ${aluno.matriculado ? "checked" : ""} 
                           onchange="toggleAluno(${aluno.id}, this.checked)">
                    <div class="aluno-info">
                        <div class="aluno-nome">${aluno.nome}</div>
                        <div class="aluno-matricula">Matr√≠cula: ${aluno.matricula}</div>
                    </div>
                    <div class="aluno-status ${aluno.matriculado ? "status-matriculado" : "status-disponivel"}">
                        ${aluno.matriculado ? "Matriculado" : "Dispon√≠vel"}
                    </div>
                </div>
            `
        )
        .join("");
    }

    // Fun√ß√£o para alternar status de matr√≠cula de um aluno
    function toggleAluno(alunoId, matricular) {
      fetch(`/admin/turmas/${turmaAtualId}/toggle-aluno/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: JSON.stringify({
          aluno_id: alunoId,
          matricular: matricular,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            // Atualizar dados locais
            const aluno = alunosData.find((a) => a.id === alunoId);
            if (aluno) {
              aluno.matriculado = matricular;
            }
            renderizarAlunos();
          } else {
            alert(data.error || "Erro ao atualizar matr√≠cula do aluno.");
          }
        });
    }

    // Fun√ß√£o para matricular alunos selecionados
    function matricularSelecionados() {
      const checkboxes = document.querySelectorAll(".aluno-checkbox:checked");
      const alunosIds = Array.from(checkboxes).map((cb) => parseInt(cb.value));

      if (alunosIds.length === 0) {
        alert("Selecione pelo menos um aluno para matricular.");
        return;
      }

      fetch(`/admin/turmas/${turmaAtualId}/matricular-lote/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: JSON.stringify({
          alunos_ids: alunosIds,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert(`${data.count} aluno(s) matriculado(s) com sucesso.`);
            carregarAlunos();
          } else {
            alert(data.error || "Erro ao matricular alunos.");
          }
        });
    }

    // Fun√ß√£o para desmatricular alunos selecionados
    function desmatricularSelecionados() {
      const checkboxes = document.querySelectorAll(".aluno-checkbox:checked");
      const alunosIds = Array.from(checkboxes).map((cb) => parseInt(cb.value));

      if (alunosIds.length === 0) {
        alert("Selecione pelo menos um aluno para desmatricular.");
        return;
      }

      if (!confirm(`Desmatricular ${alunosIds.length} aluno(s) selecionado(s)?`)) {
        return;
      }

      fetch(`/admin/turmas/${turmaAtualId}/desmatricular-lote/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
        },
        body: JSON.stringify({
          alunos_ids: alunosIds,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            alert(`${data.count} aluno(s) desmatriculado(s) com sucesso.`);
            carregarAlunos();
          } else {
            alert(data.error || "Erro ao desmatricular alunos.");
          }
        });
    }

    // Fun√ß√£o para fechar modal de alunos
    function fecharModalAlunos() {
      document.getElementById("modal-alunos-overlay").classList.remove("active");
      turmaAtualId = null;
      alunosData = [];

      // Recarregar a p√°gina para atualizar contadores
      location.reload();
    }
  </script>

  <!-- Script global de gerenciamento -->
  <script src="{% static 'js/gerenciar-global.js' %}"></script>

  <!-- Scripts espec√≠ficos da p√°gina -->
  <script>
    // Event listener para fechar modal clicando fora
    document.addEventListener("click", function (event) {
      const modals = document.querySelectorAll(".modal-overlay");
      modals.forEach((modal) => {
        if (event.target === modal) {
          modal.classList.remove("active");
        }
      });
    });
  </script>

  <!-- JavaScript Global -->
  <script src="{% static 'js/gerenciar-global.js' %}"></script>

</body>

</html>