{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if brand.enabled %}{{ brand.name_short }}{% else %}{{ brand.name_old }}{% endif %} - Relat√≥rios de Avalia√ß√µes</title>

    <!-- Favicons -->
    {% include 'partials/favicon_meta.html' %}

    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
    <link rel="stylesheet" href="{% static 'css/relatorio_avaliacoes.css' %}">
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Carregando dados...</div>
    </div>

    <div class="container">
        <!-- Bot√£o Voltar -->
        <a href="{% url 'inicio' %}" class="back-button">‚Üê Voltar para In√≠cio</a>

        <!-- Header -->
        <div class="header">
            <h1>üìä Relat√≥rios de Avalia√ß√µes</h1>
            <p>Visualize e analise os dados das avalia√ß√µes docentes</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <span>üìä Relat√≥rios</span>
        </div>

        <!-- Mensagens -->
        {% include "partials/messages.html" %}

        <!-- Se√ß√£o de Filtros -->
        <div class="form-section">
            <h2>üîç Filtros</h2>
            <form method="get" id="form-filtros">
                <div class="form-row">
                    <div class="form-group">
                        <label for="ciclo">Ciclo de Avalia√ß√£o</label>
                        <select name="ciclo" id="ciclo" class="form-control">
                            <option value="">Todos os ciclos</option>
                            {% for ciclo in ciclos %}
                            <option value="{{ ciclo.id }}" 
                                    {% if ciclo_selecionado == ciclo.id|stringformat:'s' %}selected{% endif %}>
                                {{ ciclo.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="professor">Professor</label>
                        <select name="professor" id="professor" class="form-control">
                            <option value="">Todos os professores</option>
                            {% for prof in professores %}
                            <option value="{{ prof.id }}" 
                                    {% if professor_selecionado == prof.id|stringformat:'s' %}selected{% endif %}>
                                {{ prof.user.get_full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <!-- Filtros Avan√ßados -->
                <div class="filtros-avancados">
                    <div class="form-group search-box">
                        <label for="search-avaliacoes">üîç Buscar</label>
                        <input type="text" 
                               id="search-avaliacoes" 
                               name="search"
                               value="{{ search_query }}"
                               class="form-control" 
                               placeholder="Professor, disciplina ou turma...">
                    </div>
                </div>
                
                <div class="filter-group filter-actions">
                    <button type="submit" class="btn btn-primary">
                        üîç Filtrar Relat√≥rio
                    </button>
                    <button type="button" onclick="limparFiltros()" class="btn btn-clear">
                        üîÑ Limpar Filtros
                    </button>
                    <button type="button" onclick="exportarCSV()" class="btn btn-secondary">
                        üì• Exportar CSV
                    </button>
                    <a href="{% url 'relatorio_professores' %}" class="btn btn-secondary">
                        üë• Relat√≥rio de Professores
                    </a>
                </div>
            </form>
        </div>

        <!-- Conte√∫do Principal -->
        {% if avaliacoes %}
        <div class="form-section">
            <h2>üìà Resultados</h2>
            
            <!-- Informa√ß√µes de Pagina√ß√£o -->
            <div class="pagination-info">
                {% if page_obj.has_other_pages %}
                    Mostrando <strong>{{ page_obj.start_index }}</strong> - <strong>{{ page_obj.end_index }}</strong> 
                    de <strong>{{ paginator.count }}</strong> avalia√ß√£o(√µes)
                {% else %}
                    Total: <strong id="result-count">{{ avaliacoes|length }}</strong> avalia√ß√£o(√µes) encontrada(s)
                {% endif %}
            </div>

            <!-- Controles de Itens por P√°gina -->
            {% if page_obj.has_other_pages %}
            <div class="items-per-page">
                <label for="items-per-page">Exibir:</label>
                <select id="items-per-page" class="form-control">
                    <option value="10" {% if per_page == '10' %}selected{% endif %}>10 por p√°gina</option>
                    <option value="25" {% if per_page == '25' %}selected{% endif %}>25 por p√°gina</option>
                    <option value="50" {% if per_page == '50' %}selected{% endif %}>50 por p√°gina</option>
                    <option value="100" {% if per_page == '100' %}selected{% endif %}>100 por p√°gina</option>
                </select>
            </div>
            {% endif %}

            <!-- Grid de Avalia√ß√µes -->
            <div class="avaliacoes-grid">
                {% for avaliacao in avaliacoes %}
                <div class="avaliacao-card">
                    <!-- Cabe√ßalho do Card -->
                    <div class="card-header">
                        <h4 class="card-title">{{ avaliacao.turma.disciplina.disciplina_nome }}</h4>
                        <div class="card-subtitle">
                            <i class="bi bi-person-fill"></i>
                            {{ avaliacao.professor.user.get_full_name }}
                        </div>
                    </div>
                    
                    <!-- Informa√ß√µes do Card -->
                    <div class="card-info">
                        <div class="info-item">
                            <span>Turma:</span>
                            <strong>{{ avaliacao.turma.codigo_turma }}</strong>
                        </div>
                        <div class="info-item">
                            <span>Per√≠odo:</span>
                            <strong>{{ avaliacao.turma.periodo_letivo.nome }}</strong>
                        </div>
                        <div class="info-item">
                            <span>Alunos:</span>
                            <strong>{{ avaliacao.total_alunos }}</strong>
                        </div>
                        <div class="info-item">
                            <span>Respondentes:</span>
                            <strong>{{ avaliacao.respondentes }}</strong>
                        </div>
                        <div class="info-item">
                            <span>Taxa de Resposta:</span>
                            <strong>{{ avaliacao.taxa_resposta }}%</strong>
                        </div>
                    </div>

                    <!-- Estat√≠sticas por Pergunta -->
                    {% for pergunta_stat in avaliacao.pergunta_stats %}
                    <div class="pergunta-stats">
                        <div class="pergunta-title">{{ pergunta_stat.pergunta.enunciado }}</div>
                        <div class="stats-row">
                            <div class="stat-item">
                                <div class="stat-value">{{ pergunta_stat.media|floatformat:1 }}</div>
                                <div class="stat-label">M√©dia</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ pergunta_stat.moda }}</div>
                                <div class="stat-label">Moda</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ pergunta_stat.respostas_count }}</div>
                                <div class="stat-label">Respostas</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                    <!-- Coment√°rios -->
                    {% if avaliacao.comentarios %}
                    <div class="comentarios-section">
                        <div class="comentarios-title">
                            <i class="bi bi-chat-dots"></i> Coment√°rios ({{ avaliacao.comentarios|length }})
                        </div>
                        {% for comentario in avaliacao.comentarios %}
                        <div class="comentario-card">
                            <div class="comentario-header">
                                <span class="comentario-aluno">Avalia√ß√£o An√¥nima</span>
                                <span class="comentario-data">{{ comentario.data_resposta|date:"d/m/Y H:i" }}</span>
                            </div>
                            <div class="comentario-texto">{{ comentario.valor_texto }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <!-- Controles de Pagina√ß√£o -->
            {% if page_obj.has_other_pages %}
            <div class="pagination-container">
                <ul class="pagination">
                    <!-- Primeira P√°gina -->
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if ciclo_selecionado %}&ciclo={{ ciclo_selecionado }}{% endif %}{% if professor_selecionado %}&professor={{ professor_selecionado }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">
                            ¬´ Primeira
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if ciclo_selecionado %}&ciclo={{ ciclo_selecionado }}{% endif %}{% if professor_selecionado %}&professor={{ professor_selecionado }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">
                            ‚Äπ Anterior
                        </a>
                    </li>
                    {% endif %}
                    
                    <!-- N√∫meros de P√°gina -->
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if ciclo_selecionado %}&ciclo={{ ciclo_selecionado }}{% endif %}{% if professor_selecionado %}&professor={{ professor_selecionado }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">
                                {{ num }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- √öltima P√°gina -->
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if ciclo_selecionado %}&ciclo={{ ciclo_selecionado }}{% endif %}{% if professor_selecionado %}&professor={{ professor_selecionado }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">
                            Pr√≥xima ‚Ä∫
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if ciclo_selecionado %}&ciclo={{ ciclo_selecionado }}{% endif %}{% if professor_selecionado %}&professor={{ professor_selecionado }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}&per_page={{ per_page }}">
                            √öltima ¬ª
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Estado Vazio -->
        <div class="form-section">
            <div class="empty-state">
                <h3>üìä Nenhuma avalia√ß√£o encontrada</h3>
                <p>N√£o h√° dados de avalia√ß√£o para os filtros selecionados.</p>
                <p>Tente ajustar os filtros ou aguarde a conclus√£o de avalia√ß√µes pelos alunos.</p>
            </div>
        </div>
        {% endif %}

        <!-- M√©tricas Gerais -->
        {% if metricas_gerais %}
        <div class="metricas-container">
            <h3 class="metricas-title">
                <i class="bi bi-bar-chart"></i> M√©tricas Gerais
            </h3>
            <div class="metricas-grid">
                {% for media in metricas_gerais %}
                <div class="metric-card">
                    <div class="metric-value {% if media.media >= 4 %}success{% elif media.media >= 3 %}warning{% else %}danger{% endif %}">
                        {{ media.media|floatformat:1 }}
                    </div>
                    <small class="metric-label">M√©dia</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
    // ================= Gr√°ficos por Ciclo =================
    const ciclosGraficos = JSON.parse('{{ ciclos_graficos_json|escapejs }}');

    function gerarCor(index, total){
        const hue = Math.round((360/Math.max(total,1))*index);
        return `hsl(${hue},65%,55%)`;
    }

    function montarContainerGraficos(){
        if(!ciclosGraficos.length) return;
        const wrapper = document.createElement('div');
        wrapper.style.marginTop = '50px';
        wrapper.innerHTML = `<h2 style="color: var(--cor03); margin-bottom:25px; display:flex; align-items:center; gap:10px;">üìä Gr√°ficos por Ciclo</h2>`;

        ciclosGraficos.forEach(ciclo => {
            const cicloDiv = document.createElement('div');
            cicloDiv.style.marginBottom = '40px';
            cicloDiv.innerHTML = `<h4 style="color: var(--cor03); margin-bottom:15px;">üåÄ ${ciclo.nome}</h4>`;

            const grade = document.createElement('div');
            grade.style.display = 'grid';
            grade.style.gridTemplateColumns = 'repeat(auto-fit,minmax(320px,1fr))';
            grade.style.gap = '25px';

            ciclo.perguntas.forEach((p, idx) => {
                const card = document.createElement('div');
                card.style.background = 'var(--cor07)';
                card.style.padding = '18px';
                card.style.borderRadius = '15px';
                card.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                card.style.borderTop = '4px solid var(--cor02)';

                const canvasId = `chart_c${ciclo.id}_p${p.id}`;
                card.innerHTML = `
                    <div style="font-weight:600; font-size:0.9rem; color: var(--cor03); min-height:48px; margin-bottom:10px;">${p.enunciado}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <small style="color:#555; font-weight:600;">Tipo: ${p.tipo.toUpperCase()}</small>
                        <small style="color:#222; font-weight:600;">M√©dia: ${p.media}</small>
                    </div>
                    <canvas id="${canvasId}" height="180"></canvas>`;
                grade.appendChild(card);
                cicloDiv.appendChild(grade);

                setTimeout(()=>criarGrafico(canvasId, p), 0);
            });

            wrapper.appendChild(cicloDiv);
        });
        document.querySelector('.form-section').appendChild(wrapper);
    }

    function criarGrafico(canvasId, pergunta){
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        
        let labels = Object.keys(pergunta.contagens);
        const dados = labels.map(k => pergunta.contagens[k]);
        const cores = labels.map((_,i)=>gerarCor(i, labels.length));
        
        // Definir tipo de gr√°fico e configura√ß√µes baseado no tipo da pergunta
        let tipoGrafico = 'bar';
        let datasetCfg = {
            label: 'Quantidade',
            data: dados,
            backgroundColor: cores,
            borderColor: cores,
            borderWidth: 2
        };
        
        // Configura√ß√µes espec√≠ficas por tipo de pergunta
        switch(pergunta.tipo) {
            case 'nps':
                // Para NPS, ordenar numericamente e usar gr√°fico de linha
                labels = labels.sort((a,b)=>Number(a)-Number(b));
                tipoGrafico = 'line';
                datasetCfg = {
                    label: 'Quantidade',
                    data: labels.map(k => pergunta.contagens[k]),
                    backgroundColor: 'rgba(0,253,148,0.4)',
                    borderColor: 'var(--cor02)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true
                };
                break;
                
            case 'likert':
                // Para Likert, ordenar numericamente
                labels = labels.sort((a,b)=>Number(a)-Number(b));
                break;
                
            case 'sim_nao':
                // Para Sim/N√£o, usar gr√°fico de rosca
                tipoGrafico = 'doughnut';
                datasetCfg = {
                    data: dados,
                    backgroundColor: ['#28a745', '#dc3545'],
                    borderWidth: 2
                };
                break;
                
            case 'multipla_escolha':
                // Para m√∫ltipla escolha, usar gr√°fico de barras horizontais
                tipoGrafico = 'bar';
                datasetCfg.backgroundColor = cores;
                break;
                
            case 'texto_livre':
                // Para texto livre, usar gr√°fico de barras simples
                tipoGrafico = 'bar';
                datasetCfg.backgroundColor = ['#17a2b8'];
                break;
        }
        
        // Configura√ß√µes espec√≠ficas para escalas
        let scalesConfig = {
            y: {
                beginAtZero: true,
                title: { display: true, text: 'Quantidade' },
                ticks: { precision: 0 }
            }
        };
        
        // Para gr√°ficos de rosca, n√£o mostrar escalas
        if (tipoGrafico === 'doughnut') {
            scalesConfig = {};
        } else {
            scalesConfig.x = {
                title: { display: true, text: pergunta.tipo === 'multipla_escolha' ? 'Op√ß√µes' : 'Valores' },
                ticks: { 
                    font: { size: 11 },
                    maxRotation: 45 
                }
            };
        }
        
        new Chart(ctx, {
            type: tipoGrafico,
            data: { labels: labels, datasets: [datasetCfg] },
            options: {
                responsive: true,
                plugins: {
                    legend: { 
                        display: tipoGrafico === 'doughnut',
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: (ctx) => {
                                if (tipoGrafico === 'doughnut') {
                                    return `${ctx.label}: ${ctx.parsed}`;
                                }
                                return `${ctx.label}: ${ctx.parsed.y}`;
                            }
                        }
                    }
                },
                scales: scalesConfig
            }
        });
    }

    document.addEventListener('DOMContentLoaded', montarContainerGraficos);
    </script>

    <!-- JavaScript Dedicado para Relat√≥rios -->
    <script src="{% static 'js/relatorio-avaliacoes.js' %}" defer></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</body>
</html>
