{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios de Avaliações - IF SADD</title>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Vidaloka&display=swap" rel="stylesheet">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <link rel="stylesheet" href="{% static 'css/relatorio_avaliacoes.css' %}">
</head>

<body>
    <main>
        <div class="container">
            <a href="{% url 'inicio' %}" class="back-button">← Voltar</a>

            <!-- Header da página -->
            <div class="relatorio-header">
                <h2><i class="bi bi-graph-up"></i> Relatórios de Avaliações</h2>
                <p>Visualize e analise os dados das avaliações</p>
            </div>

            <!-- Mensagens -->
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="message {{ message.tags }}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Seção de Filtros -->
            <div class="form-section">
                <div class="filtros-section">
                    <form method="get" id="form-filtros">
                        <div class="filtros-row">
                            <div class="form-group">
                                <label for="ciclo" class="form-label-report">Ciclo</label>
                                <select name="ciclo" id="ciclo" class="form-control">
                                    <option value="">Todos os ciclos</option>
                                    {% for ciclo in ciclos %}
                                    <option value="{{ ciclo.id }}" 
                                            {% if ciclo_selecionado == ciclo.id|stringformat:'s' %}selected{% endif %}>
                                        {{ ciclo.nome }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="professor" class="form-label-report">Professor</label>
                                <select name="professor" id="professor" class="form-control">
                                    <option value="">Todos os professores</option>
                                    {% for prof in professores %}
                                    <option value="{{ prof.id }}" 
                                            {% if professor_selecionado == prof.id|stringformat:'s' %}selected{% endif %}>
                                        {{ prof.user.get_full_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button type="submit" class="btn-filtrar">
                                <i class="bi bi-funnel"></i> Filtrar
                            </button>
                            <a href="javascript:void(0);" onclick="exportarCSV()" class="btn-export">
                                <i class="bi bi-download"></i> Exportar CSV
                            </a>
                        </div>
                    </form>
                </div>

                <!-- Conteúdo principal -->
                {% if avaliacoes %}
                <div class="avaliacoes-grid">
                    {% for avaliacao in avaliacoes %}
                    <div class="avaliacao-card">
                        <div class="card-header">
                            <h4 class="card-title">{{ avaliacao.turma.disciplina.disciplina_nome }}</h4>
                            <div class="card-subtitle">
                                <i class="bi bi-person-fill"></i>
                                {{ avaliacao.professor.user.get_full_name }}
                            </div>
                        </div>
                        
                        <div class="card-info">
                            <div class="info-item">
                                <span>Turma:</span>
                                <strong>{{ avaliacao.turma.codigo_turma }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Período:</span>
                                <strong>{{ avaliacao.turma.periodo_letivo.nome }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Alunos:</span>
                                <strong>{{ avaliacao.turma.alunos.count }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Respondentes:</span>
                                <strong>{{ avaliacao.respondentes }}</strong>
                            </div>
                            <div class="info-item">
                                <span>Taxa de Resposta:</span>
                                <strong>{{ avaliacao.taxa_resposta }}%</strong>
                            </div>
                        </div>

                        <!-- Estatísticas por pergunta -->
                        {% for pergunta_stat in avaliacao.pergunta_stats %}
                        <div class="pergunta-stats">
                            <div class="pergunta-title">{{ pergunta_stat.pergunta.enunciado }}</div>
                            <div class="stats-row">
                                <div class="stat-item">
                                    <div class="stat-value">{{ pergunta_stat.media|floatformat:1 }}</div>
                                    <div class="stat-label">Média</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ pergunta_stat.moda }}</div>
                                    <div class="stat-label">Moda</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ pergunta_stat.respostas_count }}</div>
                                    <div class="stat-label">Respostas</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}

                        <!-- Comentários -->
                        {% if avaliacao.comentarios %}
                        <div class="comentarios-section">
                            <div class="comentarios-title">
                                <i class="bi bi-chat-dots"></i> Comentários ({{ avaliacao.comentarios|length }})
                            </div>
                            {% for comentario in avaliacao.comentarios %}
                            <div class="comentario-card">
                                <div class="comentario-header">
                                    <span class="comentario-aluno">{{ comentario.resposta.aluno.user.get_full_name|default:"Anônimo" }}</span>
                                    <span class="comentario-data">{{ comentario.data_submissao|date:"d/m/Y H:i" }}</span>
                                </div>
                                <div class="comentario-texto">{{ comentario.texto }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Métricas Gerais -->
                {% if metricas_gerais %}
                <div class="metricas-container">
                    <h3 class="metricas-title">
                        <i class="bi bi-bar-chart"></i> Métricas Gerais
                    </h3>
                    <div class="metricas-grid">
                        {% for media in metricas_gerais %}
                        <div class="metric-card">
                            <div class="metric-value {% if media.media >= 4 %}success{% elif media.media >= 3 %}warning{% else %}danger{% endif %}">
                                {{ media.media|floatformat:1 }}
                            </div>
                            <small class="metric-label">Média</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                {% else %}
                <div class="empty-state">
                    <div class="icon">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <h4>Nenhuma avaliação encontrada</h4>
                    <p>Tente ajustar os filtros ou aguarde a conclusão de avaliações pelos alunos.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <script>
    // ================= Gráficos por Ciclo =================
    const ciclosGraficos = JSON.parse('{{ ciclos_graficos_json|escapejs }}');

    function gerarCor(index, total){
        const hue = Math.round((360/Math.max(total,1))*index);
        return `hsl(${hue},65%,55%)`;
    }

    function montarContainerGraficos(){
        if(!ciclosGraficos.length) return;
        const wrapper = document.createElement('div');
        wrapper.style.marginTop = '50px';
        wrapper.innerHTML = `<h2 style="color: var(--cor03); margin-bottom:25px; display:flex; align-items:center; gap:10px;">📊 Gráficos por Ciclo</h2>`;

        ciclosGraficos.forEach(ciclo => {
            const cicloDiv = document.createElement('div');
            cicloDiv.style.marginBottom = '40px';
            cicloDiv.innerHTML = `<h4 style="color: var(--cor03); margin-bottom:15px;">🌀 ${ciclo.nome}</h4>`;

            const grade = document.createElement('div');
            grade.style.display = 'grid';
            grade.style.gridTemplateColumns = 'repeat(auto-fit,minmax(320px,1fr))';
            grade.style.gap = '25px';

            ciclo.perguntas.forEach((p, idx) => {
                const card = document.createElement('div');
                card.style.background = 'var(--cor07)';
                card.style.padding = '18px';
                card.style.borderRadius = '15px';
                card.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
                card.style.borderTop = '4px solid var(--cor02)';

                const canvasId = `chart_c${ciclo.id}_p${p.id}`;
                card.innerHTML = `
                    <div style="font-weight:600; font-size:0.9rem; color: var(--cor03); min-height:48px; margin-bottom:10px;">${p.enunciado}</div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                        <small style="color:#555; font-weight:600;">Tipo: ${p.tipo.toUpperCase()}</small>
                        <small style="color:#222; font-weight:600;">Média: ${p.media}</small>
                    </div>
                    <canvas id="${canvasId}" height="180"></canvas>`;
                grade.appendChild(card);
                cicloDiv.appendChild(grade);

                setTimeout(()=>criarGrafico(canvasId, p), 0);
            });

            wrapper.appendChild(cicloDiv);
        });
        document.querySelector('.form-section').appendChild(wrapper);
    }

    function criarGrafico(canvasId, pergunta){
        const ctx = document.getElementById(canvasId);
        if(!ctx) return;
        const labels = Object.keys(pergunta.contagens).sort((a,b)=>Number(a)-Number(b));
        const dados = labels.map(k => pergunta.contagens[k]);
        const cores = labels.map((_,i)=>gerarCor(i, labels.length));
        const tipoGrafico = pergunta.tipo === 'nps' ? 'line' : 'bar';
        const datasetCfg = {
            label: 'Qtd',
            data: dados,
            backgroundColor: tipoGrafico==='bar'? cores : 'rgba(0,253,148,0.4)',
            borderColor: tipoGrafico==='bar'? cores : 'var(--cor02)',
            borderWidth: 2,
            tension: 0.3,
            fill: pergunta.tipo === 'nps'
        };
        new Chart(ctx, {
            type: tipoGrafico,
            data: { labels: labels, datasets: [datasetCfg] },
            options: {
                responsive:true,
                plugins:{
                    legend:{display:false},
                    tooltip:{
                        callbacks:{
                            label:(ctx)=>`Valor ${ctx.label}: ${ctx.parsed.y}`
                        }
                    }
                },
                scales:{
                    x:{
                        title:{display:true, text:'Valor'},
                        ticks:{font:{size:11}}
                    },
                    y:{
                        beginAtZero:true,
                        title:{display:true, text:'Quantidade'},
                        ticks:{precision:0}
                    }
                }
            }
        });
    }

    document.addEventListener('DOMContentLoaded', montarContainerGraficos);

    function exportarCSV() {
        // Criar URL com parâmetros atuais
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('formato', 'csv');
        
        // Redirecionar para download
        window.location.href = '{% url "relatorio_avaliacoes" %}?' + urlParams.toString();
    }

    // Auto-submit do formulário quando filtros mudarem
    document.getElementById('ciclo').addEventListener('change', function() {
        document.getElementById('form-filtros').submit();
    });

    document.getElementById('professor').addEventListener('change', function() {
        document.getElementById('form-filtros').submit();
    });
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</body>
</html>
