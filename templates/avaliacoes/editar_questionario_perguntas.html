{% load user_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Perguntas - {{ questionario.titulo }} - IF SADD</title>
    
    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS Espec√≠fico -->
    <link rel="stylesheet" href="{% static 'css/editar_questionario.css' %}">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìù Editar Perguntas do Question√°rio</h1>
            <p>{{ questionario.titulo }}</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'gerenciar_questionarios' %}">üìù Question√°rios</a>
            <span>‚Üí</span>
            <span>Editar Perguntas</span>
        </div>

        <!-- Mensagens -->
        {% if messages %}
            <div class="messages">
                {% for message in messages %}
                    <div class="message {{ message.tags }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Conte√∫do principal -->
        <div class="main-container">
            <!-- Formul√°rio de Pergunta -->
            <div class="form-section">
                <div class="form-header">
                    <h2>
                        {% if editando %}
                            <i class="bi bi-pencil-square"></i> Editar Pergunta
                        {% else %}
                            <i class="bi bi-plus-circle"></i> Nova Pergunta
                        {% endif %}
                    </h2>
                </div>
                
                <form method="post" class="question-form">
                    {% csrf_token %}
                    
                    {% if form.errors %}
                        <div class="error-message">
                            <strong>Erros no formul√°rio:</strong>
                            {{ form.errors }}
                        </div>
                    {% endif %}
                    
                    <div class="form-group">
                        <label for="{{ form.enunciado.id_for_label }}">{{ form.enunciado.label }}</label>
                        {{ form.enunciado }}
                        {% if form.enunciado.errors %}
                            <div class="field-error">
                                {% for error in form.enunciado.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.tipo.id_for_label }}">{{ form.tipo.label }}</label>
                        {{ form.tipo }}
                        {% if form.tipo.errors %}
                            <div class="field-error">
                                {% for error in form.tipo.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group" id="opcoes-container" style="display: none;">
                        <label for="{{ form.opcoes_multipla_escolha.id_for_label }}">{{ form.opcoes_multipla_escolha.label }}</label>
                        {{ form.opcoes_multipla_escolha }}
                        <small>Digite uma op√ß√£o por linha</small>
                        {% if form.opcoes_multipla_escolha.errors %}
                            <div class="field-error">
                                {% for error in form.opcoes_multipla_escolha.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.categoria.id_for_label }}">{{ form.categoria.label }}</label>
                        {{ form.categoria }}
                        {% if form.categoria.errors %}
                            <div class="field-error">
                                {% for error in form.categoria.errors %}
                                    <span>{{ error }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <div class="checkbox-group">
                            {{ form.obrigatoria }}
                            <label for="{{ form.obrigatoria.id_for_label }}">{{ form.obrigatoria.label }}</label>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        {% if editando %}
                            <button type="submit" name="salvar_edicao" class="btn btn-primary">
                                <i class="bi bi-check"></i> Salvar
                            </button>
                            <a href="{% url 'editar_questionario_perguntas' questionario.id %}" class="btn btn-secondary">
                                <i class="bi bi-x"></i> Cancelar
                            </a>
                        {% else %}
                            <button type="submit" name="adicionar_pergunta" class="btn btn-primary">
                                <i class="bi bi-plus"></i> Adicionar
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
            
            <!-- Lista de Perguntas -->
            <div class="questions-section">
                <div class="section-header">
                    <h2>Perguntas do Question√°rio</h2>
                    <span class="questions-count">{{ perguntas_existentes.count }} pergunta{{ perguntas_existentes.count|pluralize }}</span>
                </div>
                
                {% if perguntas_existentes %}
                    <div class="questions-list">
                        {% for qp in perguntas_existentes %}
                            <div class="question-card {% if editando and pergunta_editando.id == qp.pergunta.id %}editing{% endif %}">
                                <div class="question-header">
                                    <span class="question-number">{{ qp.ordem }}</span>
                                    <div class="question-content">
                                        <h3>{{ qp.pergunta.enunciado }}</h3>
                                        <div class="question-meta">
                                            <span class="question-type">
                                                {% if qp.pergunta.tipo == 'multipla_escolha' %}
                                                    <i class="bi bi-ui-radios"></i> M√∫ltipla Escolha
                                                {% elif qp.pergunta.tipo == 'texto' %}
                                                    <i class="bi bi-text-paragraph"></i> Texto Livre
                                                {% elif qp.pergunta.tipo == 'escala' %}
                                                    <i class="bi bi-bar-chart"></i> Escala de Avalia√ß√£o
                                                {% endif %}
                                            </span>
                                            {% if qp.pergunta.obrigatoria %}
                                                <span class="question-required">
                                                    <i class="bi bi-asterisk"></i> Obrigat√≥ria
                                                </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                {% if qp.pergunta.opcoes_multipla_escolha %}
                                    <div class="question-options">
                                        <div class="options-header">
                                            <i class="bi bi-list-ul"></i>
                                            <span>Op√ß√µes de resposta:</span>
                                        </div>
                                        {% for opcao in qp.pergunta.opcoes_multipla_escolha %}
                                            <div class="option">{{ forloop.counter }}. {{ opcao }}</div>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                
                                <div class="question-actions">
                                    <a href="?editar_pergunta={{ qp.pergunta.id }}" class="btn-edit">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="pergunta_id" value="{{ qp.pergunta.id }}">
                                        <button type="submit" name="remover_pergunta" class="btn-remove">
                                            <i class="bi bi-trash"></i> Remover
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <i class="bi bi-question-circle"></i>
                        <h3>Nenhuma pergunta cadastrada</h3>
                        <p>Adicione a primeira pergunta ao question√°rio usando o formul√°rio ao lado.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Mostrar/ocultar op√ß√µes m√∫ltipla escolha
        document.addEventListener('DOMContentLoaded', function() {
            const tipoSelect = document.getElementById('id_tipo');
            const opcoesContainer = document.getElementById('opcoes-container');
            
            function toggleOpcoes() {
                if (tipoSelect.value === 'multipla_escolha') {
                    opcoesContainer.style.display = 'block';
                } else {
                    opcoesContainer.style.display = 'none';
                }
            }
            
            // Verificar no carregamento
            toggleOpcoes();
            
            // Verificar quando mudar
            tipoSelect.addEventListener('change', toggleOpcoes);
            
            // Confirma√ß√£o para remo√ß√£o
            document.querySelectorAll('.btn-remove').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    if (!confirm('Tem certeza que deseja remover esta pergunta?')) {
                        e.preventDefault();
                    }
                });
            });
        });
    </script>
</body>
</html>