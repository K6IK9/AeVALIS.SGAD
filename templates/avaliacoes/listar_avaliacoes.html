{% load static %}
{% load user_tags %} 
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Avalia√ß√µes - IF SADD</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Avalia√ß√µes -->
    <link rel="stylesheet" href="{% static 'css/avaliacoes.css' %}">
</head>

<body>
    <main>
        <div class="container">
            <a href="{% url 'inicio' %}" class="back-button">‚Üê Voltar</a>

            <!-- Header da p√°gina -->
            <div class="header">
                <h1>üìã Sistema de Avalia√ß√µes</h1>
                <p>{% if user|has_role:"aluno" %}Suas avalia√ß√µes docentes dispon√≠veis{% else %}Gerencie question√°rios, ciclos e acompanhe o progresso{% endif %}</p>
            </div>

            <!-- Mensagens -->
            {% include "partials/messages.html" %}

            <!-- A√ß√µes r√°pidas - Admin/Coordenador -->
            {% if user|has_role:"coordenador" or user|has_role:"admin" %}
            <div class="form-section">
                <h2>‚ö° A√ß√µes R√°pidas</h2>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{% url 'gerenciar_questionarios' %}" class="btn btn-primary">
                        <i class="bi bi-clipboard-check"></i> Gerenciar Question√°rios
                    </a>
                    <a href="{% url 'gerenciar_categorias' %}" class="btn btn-secondary">
                        <i class="bi bi-tags"></i> Gerenciar Categorias
                    </a>
                    <a href="{% url 'gerenciar_ciclos' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-repeat"></i> Gerenciar Ciclos
                    </a>
                </div>
            </div>
            {% endif %}


            <!-- Se√ß√£o de Ciclos - Admin/Coordenador -->
            {% if user|has_role:"coordenador" or user|has_role:"admin" %}
            
            <!-- Tabela de Ciclos -->
            <div class="form-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>üîÑ Ciclos de Avalia√ß√£o</h2>
                    <div class="d-flex gap-2">
                        <span class="badge bg-success badge-ciclo-header">
                            <i class="bi bi-check-circle"></i> {{ ciclos_em_andamento|length }} Ativo(s)
                        </span>
                        <span class="badge bg-secondary badge-ciclo-header">
                            <i class="bi bi-archive"></i> {{ ciclos_finalizados|length }} Finalizado(s)
                        </span>
                    </div>
                </div>
                
                {% if ciclos_em_andamento or ciclos_finalizados %}
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th><i class="bi bi-tag"></i> Nome do Ciclo</th>
                                <th><i class="bi bi-calendar-range"></i> Per√≠odo</th>
                                <th class="text-center"><i class="bi bi-collection"></i> Turmas</th>
                                <th class="text-center"><i class="bi bi-circle-fill"></i> Status</th>
                                <th class="text-center"><i class="bi bi-gear"></i> A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Ciclos em Andamento -->
                            {% for ciclo in ciclos_em_andamento %}
                            <tr class="ciclo-ativo-row">
                                <td>
                                    <strong>{{ ciclo.nome }}</strong>
                                </td>
                                <td>
                                    <small>
                                        <i class="bi bi-calendar-event"></i> 
                                        {{ ciclo.data_inicio|date:"d/m/Y" }} - {{ ciclo.data_fim|date:"d/m/Y" }}
                                    </small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light badge-turmas-ativo">
                                        {{ ciclo.turmas.count }} turma(s)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Ativo
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex gap-1 justify-content-center flex-wrap">
                                        <a href="{% url 'detalhe_ciclo_avaliacao' ciclo.id %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Ver detalhes">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'editar_ciclo_simples' ciclo.id %}" 
                                           class="btn btn-sm btn-warning" 
                                           title="Editar ciclo">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <form method="post" 
                                              action="{% url 'encerrar_ciclo' ciclo.id %}" 
                                              onsubmit="return confirm('Encerrar o ciclo \"{{ ciclo.nome }}\"? Alunos n√£o poder√£o mais responder.');" 
                                              class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn btn-sm btn-outline-secondary" 
                                                    title="Encerrar ciclo">
                                                <i class="bi bi-stop-circle"></i>
                                            </button>
                                        </form>
                                        <form method="post" 
                                              action="{% url 'excluir_ciclo' ciclo.id %}" 
                                              onsubmit="return confirm('Tem certeza que deseja excluir o ciclo {{ ciclo.nome }}? Esta a√ß√£o n√£o pode ser desfeita.');" 
                                              class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn btn-sm btn-danger" 
                                                    title="Excluir ciclo">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            
                            <!-- Ciclos Finalizados -->
                            {% for ciclo in ciclos_finalizados %}
                            <tr class="ciclo-finalizado-row">
                                <td>
                                    <strong>{{ ciclo.nome }}</strong>
                                </td>
                                <td>
                                    <small>
                                        <i class="bi bi-calendar-event"></i> 
                                        {{ ciclo.data_inicio|date:"d/m/Y" }} - {{ ciclo.data_fim|date:"d/m/Y" }}
                                    </small>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-light badge-turmas-finalizado">
                                        {{ ciclo.turmas.count }} turma(s)
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">
                                        <i class="bi bi-stop-circle"></i> Encerrado
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="d-flex gap-1 justify-content-center flex-wrap">
                                        <a href="{% url 'detalhe_ciclo_avaliacao' ciclo.id %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Ver detalhes">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'editar_ciclo_simples' ciclo.id %}" 
                                           class="btn btn-sm btn-secondary" 
                                           title="Editar ciclo">
                                            <i class="bi bi-pencil-square"></i>
                                        </a>
                                        <form method="post" 
                                              action="{% url 'excluir_ciclo' ciclo.id %}" 
                                              onsubmit="return confirm('Tem certeza que deseja excluir o ciclo {{ ciclo.nome }}? Esta a√ß√£o n√£o pode ser desfeita.');" 
                                              class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" 
                                                    class="btn btn-sm btn-danger" 
                                                    title="Excluir ciclo">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5 empty-state-ciclos">
                    <i class="bi bi-calendar-x empty-icon"></i>
                    <h4 class="mt-3">Nenhum ciclo cadastrado</h4>
                    <p class="text-muted">Crie um novo ciclo para iniciar avalia√ß√µes</p>
                    <a href="{% url 'gerenciar_ciclos' %}" class="btn btn-primary mt-2">
                        <i class="bi bi-plus-circle"></i> Criar Novo Ciclo
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Se√ß√£o de Avalia√ß√µes - Apenas para Alunos -->
            {% if user|has_role:"aluno" %}
            <div class="form-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2>üìù Minhas Avalia√ß√µes</h2>
                    {% if avaliacoes %}
                        <span class="badge bg-primary-custom badge-count-avaliacoes">
                            {{ avaliacoes|length }} avalia√ß√£o(√µes)
                        </span>
                    {% endif %}
                </div>
                
                {% if avaliacoes %}
                <!-- Cards de avalia√ß√µes para Alunos -->
                <div class="row g-3">
                    {% for avaliacao in avaliacoes %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card card-custom card-avaliacao-aluno">
                            <div class="card-body">
                                <h5 class="mb-3">
                                    {{ avaliacao.disciplina.disciplina_nome }}
                                </h5>
                                
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-person me-2 info-icon"></i>
                                        <span><strong>Professor:</strong> {{ avaliacao.professor.user.get_full_name }}</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-collection me-2 info-icon"></i>
                                        <span><strong>Turma:</strong> {{ avaliacao.turma.codigo_turma }}</span>
                                    </div>
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="bi bi-clock me-2 info-icon"></i>
                                        <span><strong>Ciclo:</strong> {{ avaliacao.ciclo.nome }}</span>
                                    </div>
                                    <div class="d-flex align-items-start mb-2">
                                        <i class="bi bi-calendar-range me-2 info-icon"></i>
                                        <span class="info-text-small">
                                            {{ avaliacao.ciclo.data_inicio|date:"d/m/Y" }} - {{ avaliacao.ciclo.data_fim|date:"d/m/Y" }}
                                        </span>
                                    </div>
                                </div>
                                
                                {% if avaliacao.ciclo.ativo and avaliacao.status != 'finalizada' %}
                                    <a href="{% url 'responder_avaliacao' avaliacao.id %}" class="btn btn-primary w-100">
                                        <i class="bi bi-pencil-square"></i> Responder Avalia√ß√£o
                                    </a>
                                {% else %}
                                    <button class="btn btn-secondary w-100" disabled>
                                        <i class="bi bi-stop-circle"></i> Avalia√ß√£o Encerrada
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <!-- Estado vazio - Apenas para Alunos -->
                <div class="text-center py-5 empty-state-avaliacoes">
                    <i class="bi bi-clipboard-x empty-icon"></i>
                    <h4 class="mt-3">Nenhuma avalia√ß√£o dispon√≠vel</h4>
                    <p class="text-muted">N√£o h√° avalia√ß√µes abertas para responder no momento.</p>
                    <p class="text-muted"><small>Aguarde novos ciclos de avalia√ß√£o serem criados.</small></p>
                </div>
                {% endif %}
            </div>
            {% endif %}

        </div>
    </main>

    <!-- Script global para funcionalidades de gerenciamento -->
    <script src="{% static 'js/gerenciar-global.js' %}"></script>

</body>

</html>
