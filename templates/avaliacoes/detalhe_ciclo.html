{% load static %}
{% load user_tags %}


<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if brand.enabled %}{{ brand.name_short }}{% else %}{{ brand.name_old }}{% endif %} - Detalhe do Ciclo</title>

    <!-- Favicons -->
    {% include 'partials/favicon_meta.html' %}

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
</head>

<body>
    <div class="container">
        <!-- Header da p√°gina -->
        <div class="header">
            <h1>üìã Detalhe do Ciclo</h1>
            <p>Visualize informa√ß√µes detalhadas do ciclo de avalia√ß√£o</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'listar_avaliacoes' %}">üìä Avalia√ß√µes</a>
            <span>‚Üí</span>
            <a href="{% url 'gerenciar_ciclos' %}">üîÑ Ciclos</a>
            <span>‚Üí</span>
            <span>üìã Detalhe do Ciclo</span>
        </div>

        <!-- Mensagens -->
        {% include "partials/messages.html" %}

        <!-- Bot√£o Voltar -->
        <a href="{% url 'gerenciar_ciclos' %}" class="btn btn-secondary" style="margin-bottom: 20px;">
            ‚Üê Voltar para Ciclos
        </a>

        <!-- Informa√ß√µes do Ciclo -->
        <div class="form-section">
            <h2>üìÖ Informa√ß√µes do Ciclo</h2>
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 5px; color: var(--cor03);">{{ ciclo.nome }}</h3>
                {% if ciclo.descricao %}
                <p style="color: var(--cor04); margin-bottom: 0;">{{ ciclo.descricao }}</p>
                {% endif %}
            </div>
            
            <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; overflow: hidden;">
                <div class="info-item" style="overflow: hidden;">
                    <strong>Status:</strong>
                    {% if ciclo.encerrado %}
                        <span class="status-badge status-inactive">üîí Encerrado</span>
                    {% else %}
                        <span class="status-badge status-active">‚úÖ Ativo</span>
                    {% endif %}
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Tipo:</strong>
                    <span style="color: var(--cor06); overflow-wrap: break-word;">üîí An√¥nima</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>In√≠cio:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.data_inicio|date:"d/m/Y" }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Fim:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.data_fim|date:"d/m/Y" }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Per√≠odo:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.periodo_letivo.nome }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Question√°rio:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.questionario.titulo }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Criado por:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.criado_por.get_full_name|default:ciclo.criado_por.username }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Criado em:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.data_criacao|date:"d/m/Y H:i" }}</span>
                </div>
            </div>
            
            {% if user|has_role:"coordenador" or user|has_role:"admin" %}
                {% if not ciclo.encerrado %}
                    <form method="post" action="{% url 'encerrar_ciclo' ciclo.id %}" style="margin-top: 20px;" onsubmit="return confirm('Encerrar o ciclo \"{{ ciclo.nome }}\"? Alunos n√£o poder√£o mais responder.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">
                            üîí Encerrar Ciclo Manualmente
                        </button>
                    </form>
                {% else %}
                    <div style="margin-top: 20px;">
                        <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                            ‚ö†Ô∏è Este ciclo foi encerrado manualmente. Para reativ√°-lo, clique no bot√£o abaixo.
                        </p>
                        <form method="post" action="{% url 'reativar_ciclo' ciclo.id %}" style="display: inline-block;" onsubmit="return confirm('Reativar o ciclo \"{{ ciclo.nome }}\"? Alunos poder√£o voltar a responder.');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success">
                                üîì Reativar Ciclo
                            </button>
                        </form>
                    </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Estat√≠sticas -->
        <div class="form-section">
            <h2>üìä Estat√≠sticas</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ total_avaliacoes }}</div>
                    <div class="stat-label">Total de Avalia√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ avaliacoes_respondidas }}</div>
                    <div class="stat-label">Respondidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ percentual_respondidas|floatformat:1 }}%</div>
                    <div class="stat-label">Progresso</div>
                </div>
            </div>
            
            {% if user|has_role:"coordenador" or user|has_role:"admin" %}
            <div style="margin-top: 20px;">
                <a href="{% url 'relatorio_avaliacoes' %}?ciclo={{ ciclo.id }}" 
                   class="btn">
                    üìä Ver Relat√≥rio Completo
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Lista de Avalia√ß√µes -->
        <div class="form-section">
                <div class="section-header-with-filters">
                    <h2>üìù Avalia√ß√µes do Ciclo</h2>
                    
                    <!-- Filtros modernos com design de pills -->
                    <div class="filter-pills-container">
                        <button class="filter-pill filter-pill-todas active" onclick="filtrarAvaliacoes('todas')" data-filter="todas">
                            <span class="filter-icon">üìä</span>
                            <span class="filter-text">Todas</span>
                            <span class="filter-count" id="count-todas">{{ total_avaliacoes }}</span>
                        </button>
                        <button class="filter-pill filter-pill-respondidas" onclick="filtrarAvaliacoes('respondidas')" data-filter="respondidas">
                            <span class="filter-icon">‚úÖ</span>
                            <span class="filter-text">Respondidas</span>
                            <span class="filter-count" id="count-respondidas">{{ avaliacoes_respondidas }}</span>
                        </button>
                        <button class="filter-pill filter-pill-pendentes" onclick="filtrarAvaliacoes('pendentes')" data-filter="pendentes">
                            <span class="filter-icon">‚è∞</span>
                            <span class="filter-text">Pendentes</span>
                            <span class="filter-count" id="count-pendentes">{{ total_avaliacoes|add:"-"|add:avaliacoes_respondidas }}</span>
                        </button>
                    </div>
                </div>
                {% if avaliacoes_docentes %}
                <div class="table-scroll-hint">
                    <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
                </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Professor</th>
                                    <th>Disciplina</th>
                                    <th>Turma</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="avaliacoes-tbody">
                                {% for avaliacao in avaliacoes_docentes %}
                                <tr class="avaliacao-row" 
                                    data-status="{% if avaliacao.respostas.exists %}respondida{% else %}pendente{% endif %}">
                                    <td>
                                        <strong>{{ avaliacao.professor.user.get_full_name }}</strong>
                                    </td>
                                    <td>
                                        {{ avaliacao.disciplina.disciplina_nome }}
                                    </td>
                                    <td>
                                        {{ avaliacao.turma.codigo_turma }}
                                    </td>
                                    <td>
                                        {% if avaliacao.respostas.exists %}
                                            <span class="status-badge status-active">
                                                ‚úÖ Respondida
                                            </span>
                                        {% elif avaliacao.status == 'finalizada' %}
                                            <span class="status-badge" style="background: var(--cor04); color: var(--cor07);">
                                                üîí Encerrada
                                            </span>
                                        {% else %}
                                            <span class="status-badge" style="background: #ffc107; color: #212529;">
                                                ‚è∞ Pendente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            {% if avaliacao.respostas.exists %}
                                                <a href="{% url 'visualizar_avaliacao' avaliacao.id %}" 
                                                   class="btn btn-sm" title="Visualizar">
                                                    üëÅÔ∏è Ver
                                                </a>
                                            {% else %}
                                                {% if user.perfil_aluno and avaliacao.status != 'finalizada' and not ciclo.encerrado %}
                                                    <a href="{% url 'responder_avaliacao' avaliacao.id %}" 
                                                       class="btn btn-sm" title="Responder">
                                                        ‚úèÔ∏è Responder
                                                    </a>
                                                {% endif %}
                                                {% if avaliacao.status != 'finalizada' %}
                                                    {% if user|has_role:"coordenador" or user|has_role:"admin" %}
                                                        <form method="post" action="{% url 'encerrar_avaliacao' avaliacao.id %}" class="inline-form" onsubmit="return confirm('Encerrar esta avalia√ß√£o?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-secondary" title="Encerrar Avalia√ß√£o">
                                                                üîí Encerrar
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                <div class="empty-state">
                    <p class="empty-message">üìã Nenhuma avalia√ß√£o encontrada para este ciclo.</p>
                    {% if user|has_role:"coordenador" or user|has_role:"admin" %}
                    <p style="color: var(--cor04); font-size: 0.9em;">
                        As avalia√ß√µes s√£o criadas automaticamente quando alunos s√£o matriculados em turmas 
                        que t√™m professores atribu√≠dos durante o per√≠odo do ciclo.
                    </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
    function filtrarAvaliacoes(status) {
        const rows = document.querySelectorAll('.avaliacao-row');
        const pills = document.querySelectorAll('.filter-pill');
        
        // Remover classe ativa de todos os pills
        pills.forEach(pill => pill.classList.remove('active'));
        
        // Contar itens vis√≠veis
        let visibleCount = 0;
        
        rows.forEach(row => {
            let shouldShow = false;
            
            if (status === 'todas') {
                shouldShow = true;
            } else if (status === 'respondidas' && row.dataset.status === 'respondida') {
                shouldShow = true;
            } else if (status === 'pendentes' && row.dataset.status === 'pendente') {
                shouldShow = true;
            }
            
            row.style.display = shouldShow ? '' : 'none';
            if (shouldShow) visibleCount++;
        });
        
        // Adicionar classe ativa ao pill clicado
        const activePill = document.querySelector(`.filter-pill[data-filter="${status}"]`);
        if (activePill) {
            activePill.classList.add('active');
        }
        
        // Animar transi√ß√£o
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                row.style.animation = 'fadeIn 0.3s ease-in-out';
            }
        });
    }

    // Definir filtro padr√£o e adicionar anima√ß√µes
    document.addEventListener('DOMContentLoaded', function() {
        const primeiroPill = document.querySelector('.filter-pill-todas');
        if (primeiroPill) {
            primeiroPill.classList.add('active');
        }
        
        // Adicionar anima√ß√£o de entrada
        const pills = document.querySelectorAll('.filter-pill');
        pills.forEach((pill, index) => {
            pill.style.animation = `slideInFromTop 0.4s ease-out ${index * 0.1}s both`;
        });
    });
    
    // Adicionar keyframes para anima√ß√µes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    `;
    document.head.appendChild(style);
    </script>

    <!-- Script global para funcionalidades de gerenciamento -->
    <script src="{% static 'js/gerenciar-global.js' %}"></script>
</body>

</html>
