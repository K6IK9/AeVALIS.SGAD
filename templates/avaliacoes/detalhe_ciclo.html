{% load static %}
{% load user_tags %}


<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IF SADD - Detalhe do Ciclo</title>

    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
</head>

<body>
    <div class="container">
        <!-- Header da p√°gina -->
        <div class="header">
            <h1>üìã Detalhe do Ciclo</h1>
            <p>Visualize informa√ß√µes detalhadas do ciclo de avalia√ß√£o</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'listar_avaliacoes' %}">üìä Avalia√ß√µes</a>
            <span>‚Üí</span>
            <a href="{% url 'gerenciar_ciclos' %}">üîÑ Ciclos</a>
            <span>‚Üí</span>
            <span>üìã Detalhe do Ciclo</span>
        </div>

        <!-- Mensagens -->
        {% include "partials/messages.html" %}

        <!-- Bot√£o Voltar -->
        <a href="{% url 'gerenciar_ciclos' %}" class="btn btn-secondary" style="margin-bottom: 20px;">
            ‚Üê Voltar para Ciclos
        </a>

        <!-- Informa√ß√µes do Ciclo -->
        <div class="form-section">
            <h2>üìÖ Informa√ß√µes do Ciclo</h2>
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 5px; color: var(--cor03);">{{ ciclo.nome }}</h3>
                {% if ciclo.descricao %}
                <p style="color: var(--cor04); margin-bottom: 0;">{{ ciclo.descricao }}</p>
                {% endif %}
            </div>
            
            <div class="info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; overflow: hidden;">
                <div class="info-item" style="overflow: hidden;">
                    <strong>Status:</strong>
                    {% if ciclo.ativo %}
                        <span class="status-badge status-active">‚úÖ Ativo</span>
                    {% else %}
                        <span class="status-badge status-inactive">‚ùå Inativo</span>
                    {% endif %}
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Tipo:</strong>
                    <span style="color: var(--cor06); overflow-wrap: break-word;">üîí An√¥nima</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>In√≠cio:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.data_inicio|date:"d/m/Y" }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Fim:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.data_fim|date:"d/m/Y" }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Per√≠odo:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.periodo_letivo.nome }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Question√°rio:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.questionario.titulo }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Criado por:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.criado_por.get_full_name|default:ciclo.criado_por.username }}</span>
                </div>
                
                <div class="info-item" style="overflow: hidden;">
                    <strong>Criado em:</strong>
                    <span style="overflow-wrap: break-word;">{{ ciclo.data_criacao|date:"d/m/Y H:i" }}</span>
                </div>
            </div>
            
            {% if ciclo.ativo %}
                {% if user|has_role:"coordenador" or user|has_role:"admin" %}
                <form method="post" action="{% url 'encerrar_ciclo' ciclo.id %}" style="margin-top: 20px;" onsubmit="return confirm('Encerrar o ciclo \"{{ ciclo.nome }}\"? Alunos n√£o poder√£o mais responder.');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        üîí Encerrar Ciclo
                    </button>
                </form>
                {% endif %}
            {% endif %}
        </div>

        <!-- Estat√≠sticas -->
        <div class="form-section">
            <h2>üìä Estat√≠sticas</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ total_avaliacoes }}</div>
                    <div class="stat-label">Total de Avalia√ß√µes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ avaliacoes_respondidas }}</div>
                    <div class="stat-label">Respondidas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ percentual_respondidas|floatformat:1 }}%</div>
                    <div class="stat-label">Progresso</div>
                </div>
            </div>
            
            {% if user|has_role:"coordenador" or user|has_role:"admin" %}
            <div style="margin-top: 20px;">
                <a href="{% url 'relatorio_avaliacoes' %}?ciclo={{ ciclo.id }}" 
                   class="btn">
                    üìä Ver Relat√≥rio Completo
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Lista de Avalia√ß√µes -->
        <div class="form-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>üìù Avalia√ß√µes do Ciclo</h2>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="filtrarAvaliacoes('todas')">
                            Todas
                        </button>
                        <button class="btn" onclick="filtrarAvaliacoes('respondidas')">
                            Respondidas
                        </button>
                        <button class="btn btn-secondary" onclick="filtrarAvaliacoes('pendentes')">
                            Pendentes
                        </button>
                    </div>
                </div>
                {% if avaliacoes_docentes %}
                <div class="table-scroll-hint">
                    <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
                </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Professor</th>
                                    <th>Disciplina</th>
                                    <th>Turma</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="avaliacoes-tbody">
                                {% for avaliacao in avaliacoes_docentes %}
                                <tr class="avaliacao-row" 
                                    data-status="{% if avaliacao.respostas.exists %}respondida{% else %}pendente{% endif %}">
                                    <td>
                                        <strong>{{ avaliacao.professor.user.get_full_name }}</strong>
                                    </td>
                                    <td>
                                        {{ avaliacao.disciplina.disciplina_nome }}
                                    </td>
                                    <td>
                                        {{ avaliacao.turma.codigo_turma }}
                                    </td>
                                    <td>
                                        {% if avaliacao.respostas.exists %}
                                            <span class="status-badge status-active">
                                                ‚úÖ Respondida
                                            </span>
                                        {% elif avaliacao.status == 'finalizada' %}
                                            <span class="status-badge" style="background: var(--cor04); color: var(--cor07);">
                                                üîí Encerrada
                                            </span>
                                        {% else %}
                                            <span class="status-badge" style="background: #ffc107; color: #212529;">
                                                ‚è∞ Pendente
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            {% if avaliacao.respostas.exists %}
                                                <a href="{% url 'visualizar_avaliacao' avaliacao.id %}" 
                                                   class="btn btn-sm" title="Visualizar">
                                                    üëÅÔ∏è Ver
                                                </a>
                                            {% else %}
                                                {% if user.perfil_aluno and avaliacao.status != 'finalizada' and ciclo.ativo %}
                                                    <a href="{% url 'responder_avaliacao' avaliacao.id %}" 
                                                       class="btn btn-sm" title="Responder">
                                                        ‚úèÔ∏è Responder
                                                    </a>
                                                {% endif %}
                                                {% if avaliacao.status != 'finalizada' %}
                                                    {% if user|has_role:"coordenador" or user|has_role:"admin" %}
                                                        <form method="post" action="{% url 'encerrar_avaliacao' avaliacao.id %}" class="inline-form" onsubmit="return confirm('Encerrar esta avalia√ß√£o?');">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-sm btn-secondary" title="Encerrar Avalia√ß√£o">
                                                                üîí Encerrar
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                <div class="empty-state">
                    <p class="empty-message">üìã Nenhuma avalia√ß√£o encontrada para este ciclo.</p>
                    {% if user|has_role:"coordenador" or user|has_role:"admin" %}
                    <p style="color: var(--cor04); font-size: 0.9em;">
                        As avalia√ß√µes s√£o criadas automaticamente quando alunos s√£o matriculados em turmas 
                        que t√™m professores atribu√≠dos durante o per√≠odo do ciclo.
                    </p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
    function filtrarAvaliacoes(status) {
        const rows = document.querySelectorAll('.avaliacao-row');
        const buttons = document.querySelectorAll('.btn-group .btn');
        
        // Remover classe ativa de todos os bot√µes
        buttons.forEach(btn => btn.classList.remove('active'));
        
        rows.forEach(row => {
            if (status === 'todas') {
                row.style.display = '';
            } else if (status === 'respondidas' && row.dataset.status === 'respondida') {
                row.style.display = '';
            } else if (status === 'pendentes' && row.dataset.status === 'pendente') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // Adicionar classe ativa ao bot√£o clicado
        event.target.classList.add('active');
    }

    // Definir filtro padr√£o
    document.addEventListener('DOMContentLoaded', function() {
        const primeiroBtn = document.querySelector('.btn-group .btn');
        if (primeiroBtn) {
            primeiroBtn.classList.add('active');
        }
    });
    </script>

    <!-- Script global para funcionalidades de gerenciamento -->
    <script src="{% static 'js/gerenciar-global.js' %}"></script>
</body>

</html>
