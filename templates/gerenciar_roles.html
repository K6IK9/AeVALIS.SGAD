{% load user_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IF SADD - Gerenciar Roles</title>
    
    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
    <!-- CSS Espec√≠fico de Roles -->
    <link rel="stylesheet" href="{% static 'css/gerenciar_roles.css' %}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciamento de Permiss√µes de Usu√°rios</h1>
            <p>Gerencie as permiss√µes e roles dos usu√°rios do sistema</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
            <span>‚Üí</span>
            <span>üîê Permiss√µes</span>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-section">
            <div class="section-header">
                <h2>Usu√°rios Cadastrados</h2>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <h3 class="filters-title">Filtros e Busca</h3>
                <form method="get" id="filtros-form">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="busca">Buscar por Nome/Matr√≠cula:</label>
                            <div class="search-box">
                                <input type="text" name="busca" id="busca" class="form-control"
                                    value="{{ request.GET.busca }}"
                                    placeholder="Digite o nome ou matr√≠cula do usu√°rio...">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="role">Filtrar por Role:</label>
                            <select name="role" id="role" class="form-control" onchange="aplicarFiltros()">
                                <option value="">Todas as roles</option>
                                <option value="admin" {% if request.GET.role == 'admin' %}selected{% endif %}>Admin
                                </option>
                                <option value="coordenador" {% if request.GET.role == 'coordenador' %}selected{% endif %}>
                                    Coordenador</option>
                                <option value="professor" {% if request.GET.role == 'professor' %}selected{% endif %}>
                                    Professor</option>
                                <option value="aluno" {% if request.GET.role == 'aluno' %}selected{% endif %}>Aluno
                                </option>
                                <option value="sem_role" {% if request.GET.role == 'sem_role' %}selected{% endif %}>Sem
                                    Role</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button type="submit" class="btn-filter">üîç Pesquisar</button>
                        </div>
                        <div class="filter-group">
                            <button type="button" class="btn-filter" onclick="limparFiltros()">Limpar Filtros</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Lista de Usu√°rios com Permiss√µes -->
            <div class="form-section">
                <div class="section-header">
                    <h2>üë• Gerenciamento de Permiss√µes ({{ usuarios_com_roles|length }})</h2>
                </div>

                {% if usuarios_com_roles %}
                <div class="table-scroll-hint">
                    <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
                </div>
                <div class="table-responsive">
                    <table class="data-table users-table roles-table">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Nome</th>
                                <th>Matr√≠cula</th>
                                <th>Email</th>
                                <th>Role Atual</th>
                                <th>Data de Cadastro</th>
                                <th class="actions-column">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in usuarios_com_roles %}
                            <tr>
                                <td>
                                    <div class="user-avatar">
                                        {{ item.usuario.first_name|first|upper|default:"U" }}
                                    </div>
                                </td>
                                <td data-label="Nome">
                                    <strong>{{ item.usuario.get_full_name|default:item.usuario.username }}</strong>
                                </td>
                                <td data-label="Matr√≠cula">
                                    {% if item.usuario.perfil_aluno %}
                                        {{ item.usuario.perfil_aluno.matricula|default:"N√£o informada" }}
                                    {% elif item.usuario.perfil_professor %}
                                        {{ item.usuario.perfil_professor.registro_academico|default:"N√£o informada" }}
                                    {% else %}
                                        {{ item.usuario.username|default:"N√£o informada" }}
                                    {% endif %}
                                </td>
                                <td data-label="Email">{{ item.usuario.email|default:"N√£o informado" }}</td>
                                <td data-label="Role Atual">
                                    <span class="role-badge role-{{ item.role|lower|cut:' '|cut:'√£'|cut:'√≠' }}">
                                        {{ item.role }}
                                        {% if item.role_manual %}
                                            <small title="Role definida manualmente (n√£o ser√° alterada pelo SUAP)">üîí</small>
                                        {% endif %}
                                    </span>
                                </td>
                                <td data-label="Data de Cadastro">{{ item.usuario.date_joined|date:"d/m/Y H:i" }}</td>
                                <td data-label="A√ß√µes" class="actions-column">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary"
                                            onclick="alterarRole({{ item.usuario.id }}, '{{ item.usuario.first_name }} {{ item.usuario.last_name }}', '{{ item.usuario.username }}', '{{ item.role }}')"
                                            title="Alterar permiss√µes do usu√°rio">
                                            ‚úèÔ∏è Alterar Role
                                        </button>
                                        {% if item.role_manual and user|get_user_role == 'Administrador' %}
                                        <button class="btn btn-sm btn-warning"
                                            onclick="resetarRoleAutomatica({{ item.usuario.id }}, '{{ item.usuario.username }}')"
                                            title="Permitir que o SUAP volte a gerenciar automaticamente a role">
                                            üîì Resetar Auto
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center-table">
                                    Nenhum usu√°rio encontrado.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <p class="empty-message">Nenhum usu√°rio encontrado.</p>
                </div>
                {% endif %}
            </div>

        <!-- Modal para Altera√ß√£o de Role -->
        <div id="modal-overlay" class="modal-overlay" onclick="fecharModal(event)">
            <div id="role-modal" class="role-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Alterar Permiss√µes do Usu√°rio</h3>
                    <button type="button" class="btn-close-modal" onclick="fecharModal()">
                        ‚úï Fechar
                    </button>
                </div>

                <div class="modal-content">
                    <div id="user-info" class="user-info">
                        <!-- Informa√ß√µes do usu√°rio ser√£o carregadas aqui -->
                    </div>

                    <form id="role-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="usuario-id" name="usuario" value="">

                        <div class="form-group">
                            <label for="role-select">Nova Role:</label>
                            <select id="role-select" name="role" class="form-control" required>
                                <option value="">Selecione uma role</option>
                                <option value="admin">Admin</option>
                                <option value="coordenador">Coordenador</option>
                                <option value="professor">Professor</option>
                                <option value="aluno">Aluno</option>
                            </select>
                        </div>

                        <div class="actions-end">
                            <button type="button" class="btn-action btn-cancel"
                                onclick="fecharModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn-action btn-edit">
                                Alterar Permiss√µes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let usuarioAtual = null;

        // Fechar modal com tecla Escape
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                fecharModal();
            }
        });

        function aplicarFiltros() {
            document.getElementById('filtros-form').submit();
        }

        function limparFiltros() {
            document.getElementById('busca').value = '';
            document.getElementById('role').value = '';
            aplicarFiltros();
        }

        function alterarRole(userId, nome, matricula, roleAtual) {
            usuarioAtual = userId;

            // Atualizar informa√ß√µes do usu√°rio
            document.getElementById('user-info').innerHTML = `
                <h4>Dados do Usu√°rio</h4>
                <p><strong>Nome:</strong> ${nome}</p>
                <p><strong>Matr√≠cula:</strong> ${matricula}</p>
                <p><strong>Role Atual:</strong> <span class="role-badge role-${roleAtual.toLowerCase()}">${roleAtual}</span></p>
            `;

            // Definir o ID do usu√°rio no formul√°rio
            document.getElementById('usuario-id').value = userId;

            // Limpar sele√ß√£o anterior
            document.getElementById('role-select').value = '';

            // Mostrar modal
            document.getElementById('modal-overlay').classList.add('active');
        }

        function resetarRoleAutomatica(userId, username) {
            if (confirm(`Tem certeza que deseja permitir que o SUAP volte a gerenciar automaticamente a role do usu√°rio ${username}?\n\nIsso significa que a role ser√° redefinida baseada no tipo de usu√°rio no SUAP no pr√≥ximo login.`)) {
                window.location.href = `/resetar-role-automatica/${userId}/`;
            }
        }

        function fecharModal(event) {
            // Se o evento for fornecido e n√£o for clique no overlay, n√£o fechar
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('btn-close-modal')) {
                return;
            }

            document.getElementById('modal-overlay').classList.remove('active');
            usuarioAtual = null;

            // Limpar formul√°rio
            document.getElementById('role-form').reset();
        }

        // Busca em tempo real (com delay)
        let timeoutId;
        const buscaElement = document.getElementById('busca');
        if (buscaElement) {
            buscaElement.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    aplicarFiltros();
                }
            });
        }

        // Drag scroll functionality para a tabela
        function enableDragScroll() {
            const tableContainer = document.querySelector('.table-responsive');
            if (!tableContainer) return;
            
            let isDown = false;
            let startX;
            let scrollLeft;

            tableContainer.addEventListener('mousedown', (e) => {
                // Evitar drag em elementos interativos
                if (e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'BUTTON' || 
                    e.target.tagName === 'A' ||
                    e.target.closest('button') ||
                    e.target.closest('a')) {
                    return;
                }
                
                isDown = true;
                tableContainer.classList.add('grabbing');
                startX = e.pageX - tableContainer.offsetLeft;
                scrollLeft = tableContainer.scrollLeft;
                e.preventDefault();
            });

            tableContainer.addEventListener('mouseleave', () => {
                isDown = false;
                tableContainer.classList.remove('grabbing');
            });

            tableContainer.addEventListener('mouseup', () => {
                isDown = false;
                tableContainer.classList.remove('grabbing');
            });

            tableContainer.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - tableContainer.offsetLeft;
                const walk = (x - startX) * 2;
                tableContainer.scrollLeft = scrollLeft - walk;
            });

            // Touch events for mobile
            tableContainer.addEventListener('touchstart', (e) => {
                if (e.target.tagName === 'INPUT' || 
                    e.target.tagName === 'BUTTON' || 
                    e.target.tagName === 'A') {
                    return;
                }
                
                isDown = true;
                startX = e.touches[0].pageX - tableContainer.offsetLeft;
                scrollLeft = tableContainer.scrollLeft;
            });

            tableContainer.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                const x = e.touches[0].pageX - tableContainer.offsetLeft;
                const walk = (x - startX) * 2;
                tableContainer.scrollLeft = scrollLeft - walk;
            });

            tableContainer.addEventListener('touchend', () => {
                isDown = false;
            });

            // Scroll smooth behavior
            tableContainer.style.scrollBehavior = 'auto';
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            enableDragScroll();
        });
    </script>
</body>

</html>