{% load user_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IF SADD - Gerenciar Roles</title>
    
    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
    <!-- CSS Espec√≠fico de Roles -->
    <link rel="stylesheet" href="{% static 'css/gerenciar_roles.css' %}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciamento de Permiss√µes de Usu√°rios</h1>
            <p>Gerencie as permiss√µes e roles dos usu√°rios do sistema</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
            <span>‚Üí</span>
            <span>üîê Permiss√µes</span>
        </div>

        {% include "partials/messages.html" %}

        <!-- Se√ß√£o de Filtros -->
        <div class="filters-section" id="filtersSection">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="searchUsuario">Buscar por Nome/Matr√≠cula:</label>
                    <input type="text" id="searchUsuario" placeholder="Digite o nome ou matr√≠cula do usu√°rio">
                </div>
                
                <div class="filter-group">
                    <label for="filterRole">Filtrar por Role:</label>
                    <select id="filterRole">
                        <option value="">Todas as roles</option>
                        <option value="admin">Admin</option>
                        <option value="coordenador">Coordenador</option>
                        <option value="professor">Professor</option>
                        <option value="aluno">Aluno</option>
                        <option value="sem_role">Sem Role</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <button type="button" onclick="clearFilters()" class="btn btn-clear">Limpar Filtros</button>
                </div>
            </div>
        </div>

        <!-- Lista de Usu√°rios com Permiss√µes -->
        <div class="form-section">
            <div class="section-header">
                <h2>üë• Gerenciamento de Permiss√µes ({{ usuarios_com_roles|length }})</h2>
            </div>

                {% if usuarios_com_roles %}
                <div class="table-scroll-hint">
                    <small>üí° Dica: Arraste a tabela lateralmente para ver mais colunas</small>
                </div>
                <div class="table-responsive">
                    <table class="data-table users-table roles-table" id="rolesTable">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Nome</th>
                                <th>Matr√≠cula</th>
                                <th>Email</th>
                                <th>Role Atual</th>
                                <th>Data de Cadastro</th>
                                <th class="actions-column">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in usuarios_com_roles %}
                            <tr>
                                <td>
                                    <div class="user-avatar">
                                        {{ item.usuario.first_name|first|upper|default:"U" }}
                                    </div>
                                </td>
                                <td data-label="Nome">
                                    <strong>{{ item.usuario.get_full_name|default:item.usuario.username }}</strong>
                                </td>
                                <td data-label="Matr√≠cula">
                                    {% if item.usuario.perfil_aluno %}
                                        {{ item.usuario.perfil_aluno.matricula|default:"N√£o informada" }}
                                    {% elif item.usuario.perfil_professor %}
                                        {{ item.usuario.perfil_professor.registro_academico|default:"N√£o informada" }}
                                    {% else %}
                                        {{ item.usuario.username|default:"N√£o informada" }}
                                    {% endif %}
                                </td>
                                <td data-label="Email">{{ item.usuario.email|default:"N√£o informado" }}</td>
                                <td data-label="Role Atual">
                                    <span class="role-badge role-{{ item.role|lower|cut:' '|cut:'√£'|cut:'√≠' }}">
                                        {{ item.role }}
                                        {% if item.role_manual %}
                                            <small title="Role definida manualmente (n√£o ser√° alterada pelo SUAP)">üîí</small>
                                        {% endif %}
                                    </span>
                                </td>
                                <td data-label="Data de Cadastro">{{ item.usuario.date_joined|date:"d/m/Y H:i" }}</td>
                                <td data-label="A√ß√µes" class="actions-column">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary"
                                            onclick="alterarRole({{ item.usuario.id }}, '{{ item.usuario.first_name }} {{ item.usuario.last_name }}', '{{ item.usuario.username }}', '{{ item.role }}')"
                                            title="Alterar permiss√µes do usu√°rio">
                                            ‚úèÔ∏è Alterar Role
                                        </button>
                                        {% if item.role_manual and user|get_user_role == 'Administrador' %}
                                        <button class="btn btn-sm btn-warning"
                                            onclick="resetarRoleAutomatica({{ item.usuario.id }}, '{{ item.usuario.username }}')"
                                            title="Permitir que o SUAP volte a gerenciar automaticamente a role">
                                            üîì Resetar Auto
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center-table">
                                    Nenhum usu√°rio encontrado.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="empty-state">
                    <p class="empty-message">Nenhum usu√°rio encontrado.</p>
                </div>
                {% endif %}
            </div>

        <!-- Modal para Altera√ß√£o de Role -->
        <div id="modal-overlay" class="modal-overlay">
            <div id="role-modal" class="role-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Alterar Permiss√µes do Usu√°rio</h3>
                    <button type="button" class="btn-close-modal" onclick="closeModal('modal-overlay'); usuarioAtual = null; document.getElementById('role-form').reset();">
                        ‚úï Fechar
                    </button>
                </div>

                <div class="modal-content">
                    <div id="user-info" class="user-info">
                        <!-- Informa√ß√µes do usu√°rio ser√£o carregadas aqui -->
                    </div>

                    <form id="role-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="usuario-id" name="usuario" value="">

                        <div class="form-group">
                            <label for="role-select">Nova Role:</label>
                            <select id="role-select" name="role" class="form-control" required>
                                <option value="">Selecione uma role</option>
                                <option value="admin">Admin</option>
                                <option value="coordenador">Coordenador</option>
                                <option value="professor">Professor</option>
                                <option value="aluno">Aluno</option>
                            </select>
                        </div>

                        <div class="actions-end">
                            <button type="button" class="btn btn-secondary"
                                onclick="closeModal('modal-overlay'); usuarioAtual = null; document.getElementById('role-form').reset();">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-success">
                                Alterar Permiss√µes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Script global de gerenciamento -->
    <script src="{% static 'js/gerenciar-global.js' %}"></script>

    <script>
        let usuarioAtual = null;

        // Fechar modal com tecla Escape (removido - agora usa o global)

        // Filtros client-side
        function filterTableRoles() {
            const searchInput = document.getElementById('searchUsuario').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value.toLowerCase();
            const table = document.getElementById('rolesTable');
            const rows = table.getElementsByTagName('tr');
            let visibleCount = 0;

            // Iterar sobre todas as linhas da tabela (exceto cabe√ßalho)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                
                if (cells.length > 0) {
                    // Extrair dados da linha
                    const nome = cells[1].textContent.toLowerCase();
                    const matricula = cells[2].textContent.toLowerCase();
                    const email = cells[3].textContent.toLowerCase();
                    const role = cells[4].textContent.toLowerCase();
                    
                    // Aplicar filtros
                    const matchesSearch = searchInput === '' || 
                        nome.includes(searchInput) || 
                        matricula.includes(searchInput) ||
                        email.includes(searchInput);
                    
                    const matchesRole = roleFilter === '' || role.includes(roleFilter);
                    
                    // Mostrar/ocultar linha
                    if (matchesSearch && matchesRole) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                }
            }

            // Atualizar contador
            const sectionHeader = document.querySelector('.section-header h2');
            if (sectionHeader) {
                sectionHeader.textContent = `üë• Gerenciamento de Permiss√µes (${visibleCount})`;
            }
        }

        function clearFilters() {
            document.getElementById('searchUsuario').value = '';
            document.getElementById('filterRole').value = '';
            filterTableRoles();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchUsuario');
            const roleFilter = document.getElementById('filterRole');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterTableRoles);
            }
            
            if (roleFilter) {
                roleFilter.addEventListener('change', filterTableRoles);
            }
        });

        function alterarRole(userId, nome, matricula, roleAtual) {
            usuarioAtual = userId;

            // Atualizar informa√ß√µes do usu√°rio
            document.getElementById('user-info').innerHTML = `
                <h4>Dados do Usu√°rio</h4>
                <p><strong>Nome:</strong> ${nome}</p>
                <p><strong>Matr√≠cula:</strong> ${matricula}</p>
                <p><strong>Role Atual:</strong> <span class="role-badge role-${roleAtual.toLowerCase()}">${roleAtual}</span></p>
            `;

            // Definir o ID do usu√°rio no formul√°rio
            document.getElementById('usuario-id').value = userId;

            // Limpar sele√ß√£o anterior
            document.getElementById('role-select').value = '';

            // Mostrar modal usando a fun√ß√£o global
            openModal('modal-overlay');
        }

        function resetarRoleAutomatica(userId, username) {
            if (confirm(`Tem certeza que deseja permitir que o SUAP volte a gerenciar automaticamente a role do usu√°rio ${username}?\n\nIsso significa que a role ser√° redefinida baseada no tipo de usu√°rio no SUAP no pr√≥ximo login.`)) {
                window.location.href = `/resetar-role-automatica/${userId}/`;
            }
        }

        // Fun√ß√£o fecharModal removida - agora usa closeModal global

        // Inicializar componentes quando a p√°gina carrega
        document.addEventListener('DOMContentLoaded', function() {
            // Filtros j√° inicializados acima
        });

    </script>
</body>

</html>