{% load user_tags %}
{% load static %}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IF SADD - Gerenciar Roles</title>
    
    <!-- CSS Global -->
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <!-- CSS de Gerenciamento -->
    <link rel="stylesheet" href="{% static 'css/gerenciar.css' %}">
    <!-- CSS Espec√≠fico de Roles -->
    <link rel="stylesheet" href="{% static 'css/gerenciar_roles.css' %}">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>Gerenciamento de Permiss√µes de Usu√°rios</h1>
            <p>Gerencie as permiss√µes e roles dos usu√°rios do sistema</p>
        </div>

        <!-- Navega√ß√£o Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="{% url 'inicio' %}">üè† In√≠cio</a>
            <span>‚Üí</span>
            <a href="{% url 'admin_hub' %}">‚öôÔ∏è Administra√ß√£o</a>
            <span>‚Üí</span>
            <span>üîê Permiss√µes</span>
        </div>

        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="message {{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <div class="form-section">
            <div class="section-header">
                <h2>Usu√°rios Cadastrados</h2>
            </div>

            <!-- Filtros -->
            <div class="filters-section">
                <h3 style="margin: 0 0 15px 0; color: var(--cor03, #376f6c);">Filtros e Busca</h3>
                <form method="get" id="filtros-form">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="busca">Buscar por Nome/Matr√≠cula:</label>
                            <div class="search-box">
                                <input type="text" name="busca" id="busca" class="form-control"
                                    value="{{ request.GET.busca }}"
                                    placeholder="Digite o nome ou matr√≠cula do usu√°rio...">
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="role">Filtrar por Role:</label>
                            <select name="role" id="role" class="form-control" onchange="aplicarFiltros()">
                                <option value="">Todas as roles</option>
                                <option value="admin" {% if request.GET.role == 'admin' %}selected{% endif %}>Admin
                                </option>
                                <option value="coordenador" {% if request.GET.role == 'coordenador' %}selected{% endif %}>
                                    Coordenador</option>
                                <option value="professor" {% if request.GET.role == 'professor' %}selected{% endif %}>
                                    Professor</option>
                                <option value="aluno" {% if request.GET.role == 'aluno' %}selected{% endif %}>Aluno
                                </option>
                                <option value="sem_role" {% if request.GET.role == 'sem_role' %}selected{% endif %}>Sem
                                    Role</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <button type="submit" class="btn-filter">üîç Pesquisar</button>
                        </div>
                        <div class="filter-group">
                            <button type="button" class="btn-filter" onclick="limparFiltros()">Limpar Filtros</button>
                        </div>
                    </div>
                </form>
            </div>

            <div class="user-count">
                Total de usu√°rios: <span id="users-count">{{ usuarios_com_roles|length }}</span>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Matr√≠cula</th>
                        <th>Email</th>
                        <th>Role Atual</th>
                        <th>Data de Cadastro</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in usuarios_com_roles %}
                    <tr>
                        <td>{{ item.usuario.first_name }} {{ item.usuario.last_name|default:"" }}</td>
                        <td>{{ item.usuario.username }}</td>
                        <td>{{ item.usuario.email|default:"N√£o informado" }}</td>
                        <td>
                            <span class="role-badge role-{{ item.role|lower|cut:' '|cut:'√£'|cut:'√≠' }}">
                                {{ item.role }}
                            </span>
                        </td>
                        <td>{{ item.usuario.date_joined|date:"d/m/Y H:i" }}</td>
                        <td>
                            <button class="btn-action btn-edit"
                                onclick="alterarRole({{ item.usuario.id }}, '{{ item.usuario.first_name }} {{ item.usuario.last_name }}', '{{ item.usuario.username }}', '{{ item.role }}')">
                                Alterar Role
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px;">
                            Nenhum usu√°rio encontrado.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Modal para Altera√ß√£o de Role -->
        <div id="modal-overlay" class="modal-overlay" onclick="fecharModal(event)">
            <div id="role-modal" class="role-modal" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3>Alterar Permiss√µes do Usu√°rio</h3>
                    <button type="button" class="btn-close-modal" onclick="fecharModal()">
                        ‚úï Fechar
                    </button>
                </div>

                <div class="modal-content">
                    <div id="user-info" class="user-info">
                        <!-- Informa√ß√µes do usu√°rio ser√£o carregadas aqui -->
                    </div>

                    <form id="role-form" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="usuario-id" name="usuario" value="">

                        <div class="form-group">
                            <label for="role-select">Nova Role:</label>
                            <select id="role-select" name="role" class="form-control" required>
                                <option value="">Selecione uma role</option>
                                <option value="admin">Admin</option>
                                <option value="coordenador">Coordenador</option>
                                <option value="professor">Professor</option>
                                <option value="aluno">Aluno</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                            <button type="button" class="btn-action" style="background: #6c757d; color: white;"
                                onclick="fecharModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn-action btn-edit">
                                Alterar Permiss√µes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let usuarioAtual = null;

        // Fechar modal com tecla Escape
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') {
                fecharModal();
            }
        });

        function aplicarFiltros() {
            document.getElementById('filtros-form').submit();
        }

        function limparFiltros() {
            document.getElementById('busca').value = '';
            document.getElementById('role').value = '';
            aplicarFiltros();
        }

        function alterarRole(userId, nome, matricula, roleAtual) {
            usuarioAtual = userId;

            // Atualizar informa√ß√µes do usu√°rio
            document.getElementById('user-info').innerHTML = `
                <h4>Dados do Usu√°rio</h4>
                <p><strong>Nome:</strong> ${nome}</p>
                <p><strong>Matr√≠cula:</strong> ${matricula}</p>
                <p><strong>Role Atual:</strong> <span class="role-badge role-${roleAtual.toLowerCase()}">${roleAtual}</span></p>
            `;

            // Definir o ID do usu√°rio no formul√°rio
            document.getElementById('usuario-id').value = userId;

            // Limpar sele√ß√£o anterior
            document.getElementById('role-select').value = '';

            // Mostrar modal
            document.getElementById('modal-overlay').classList.add('active');
        }

        function fecharModal(event) {
            // Se o evento for fornecido e n√£o for clique no overlay, n√£o fechar
            if (event && event.target !== event.currentTarget && !event.target.classList.contains('btn-close-modal')) {
                return;
            }

            document.getElementById('modal-overlay').classList.remove('active');
            usuarioAtual = null;

            // Limpar formul√°rio
            document.getElementById('role-form').reset();
        }

        // Busca em tempo real (com delay)
        let timeoutId;
        document.getElementById('busca').addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                aplicarFiltros();
            }
        });
    </script>
</body>

</html>